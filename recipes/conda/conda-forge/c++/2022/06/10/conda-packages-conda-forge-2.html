<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Conda package for compiled native libraries | J-M’s “lab notebook”</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Conda package for compiled native libraries" />
<meta name="author" content="<a href='https://github.com/jmp75'>J-M</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Journey in building a conda package for C++ libraries" />
<meta property="og:description" content="Journey in building a conda package for C++ libraries" />
<link rel="canonical" href="https://jmp75.github.io/work-blog/recipes/conda/conda-forge/c++/2022/06/10/conda-packages-conda-forge-2.html" />
<meta property="og:url" content="https://jmp75.github.io/work-blog/recipes/conda/conda-forge/c++/2022/06/10/conda-packages-conda-forge-2.html" />
<meta property="og:site_name" content="J-M’s “lab notebook”" />
<meta property="og:image" content="https://docs.conda.io/en/latest/_images/conda_logo.svg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-10T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://docs.conda.io/en/latest/_images/conda_logo.svg" />
<meta property="twitter:title" content="Conda package for compiled native libraries" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='https://github.com/jmp75'>J-M</a>"},"dateModified":"2022-06-10T00:00:00-05:00","datePublished":"2022-06-10T00:00:00-05:00","description":"Journey in building a conda package for C++ libraries","headline":"Conda package for compiled native libraries","image":"https://docs.conda.io/en/latest/_images/conda_logo.svg","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmp75.github.io/work-blog/recipes/conda/conda-forge/c++/2022/06/10/conda-packages-conda-forge-2.html"},"url":"https://jmp75.github.io/work-blog/recipes/conda/conda-forge/c++/2022/06/10/conda-packages-conda-forge-2.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/work-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmp75.github.io/work-blog/feed.xml" title="J-M's &quot;lab notebook&quot;" /><link rel="shortcut icon" type="image/x-icon" href="/work-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/work-blog/">J-M&#39;s &quot;lab notebook&quot;</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/work-blog/drafts/2022-06-XX-conda-channels-local-channel.html">Setting up a private conda channel - part 1</a><a class="page-link" href="/work-blog/about/">About Me</a><a class="page-link" href="/work-blog/search/">Search</a><a class="page-link" href="/work-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Conda package for compiled native libraries</h1><p class="page-description">Journey in building a conda package for C++ libraries</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-10T00:00:00-05:00" itemprop="datePublished">
        Jun 10, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://github.com/jmp75'>J-M</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/work-blog/categories/#recipes">recipes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#conda">conda</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#conda-forge">conda-forge</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#C++">C++</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#background">Background</a></li>
<li class="toc-entry toc-h1"><a href="#market-review">Market review</a></li>
<li class="toc-entry toc-h1"><a href="#walkthrough">Walkthrough</a>
<ul>
<li class="toc-entry toc-h2"><a href="#starting-point">Starting point</a></li>
<li class="toc-entry toc-h2"><a href="#building-locally-on-linux64">Building locally on linux64</a></li>
<li class="toc-entry toc-h2"><a href="#building-locally-on-win64">Building locally on win64</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#recapitulation-and-summary">Recapitulation and summary</a></li>
<li class="toc-entry toc-h1"><a href="#acknowledgements">Acknowledgements</a></li>
<li class="toc-entry toc-h1"><a href="#appendices">Appendices</a>
<ul>
<li class="toc-entry toc-h2"><a href="#appendix-if-missing-ms-build-tools-2017">Appendix: if missing ms build tools 2017</a></li>
<li class="toc-entry toc-h2"><a href="#resources">Resources</a></li>
</ul>
</li>
</ul><h1 id="background">
<a class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h1>

<p>I recently wrote about <a href="https://jmp75.github.io/work-blog/recipes/conda/conda-forge/2022/06/04/conda-packages-conda-forge.html">submitting your first conda package to conda-forge</a>. You’ll find background on the “bigger picture” endeavour in that previous post.</p>

<p>This post is a follow-on with, perhaps, a second submission to conda-forge, this time not of a python package but a C++ library.</p>

<p>I’ll try to package a relatively small C++ codebase <a href="https://github.com/csiro-hydroinformatics/moirai">MOIRAI: Manage C++ objects lifetime when exposed through a C API</a>. While dealing with very similar needs as refcount (reference counting and memory management), there is no explicit dependency between them.</p>

<h1 id="market-review">
<a class="anchor" href="#market-review" aria-hidden="true"><span class="octicon octicon-link"></span></a>Market review</h1>

<p><code class="language-plaintext highlighter-rouge">moirai</code> grew out of specific projects almost a decade ago, but its inception did not occur without looking first at third party options. There were surprisingly few I could identify, and of the ones I saw licensing or design made it difficult to adopt as they were. Still, in 2022 is there, on conda-forge or not, something making <code class="language-plaintext highlighter-rouge">moirai</code> possibly redundant?</p>

<p>It can be tricky to find relevant work without a time consuming research. A cursory scan comes up:</p>

<ul>
  <li>
<a href="https://anaconda.org/conda-forge/cppy">Cppy</a> seems to have intersects, but this is solely Python-centric.</li>
  <li>
<a href="https://github.com/vancegroup-mirrors/loki-lib">Loki-lib</a> is an (underappreciated) library with reference counting features, but not on conda-forge. I believe Loki-lib was largely written by <a href="https://erdani.org/index.html">Andrei Alexandrescu</a>, author of <a href="http://amazon.com/exec/obidos/ASIN/0201704315/modecdesi-20">Modern C++ Design</a>, one of the most impressive computer science book I read.</li>
</ul>

<p>Maybe there is a place for <code class="language-plaintext highlighter-rouge">moirai</code>. Plus the name is not taken…</p>

<h1 id="walkthrough">
<a class="anchor" href="#walkthrough" aria-hidden="true"><span class="octicon octicon-link"></span></a>Walkthrough</h1>

<p>I already forked and cloned staged-recipes from the previous post.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/src/staged-recipes
git checkout main
git branch moirai
</code></pre></div></div>

<h2 id="starting-point">
<a class="anchor" href="#starting-point" aria-hidden="true"><span class="octicon octicon-link"></span></a>Starting point</h2>

<p><a href="https://github.com/conda-incubator/grayskull#introduction"><code class="language-plaintext highlighter-rouge">grayskull</code></a> is userful to generate meta.yaml stubs out of python packages, and not applicable in this case.</p>

<p>I learned the hard way that installing conda-build, grayskull and shyaml and <code class="language-plaintext highlighter-rouge">conda update conda</code>in my conda base environment landed me in a broken mamba and incompatible package versions. So, this time create a new dedicate environment:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create <span class="nt">-n</span> cf <span class="nv">python</span><span class="o">=</span>3.9 mamba <span class="nt">-c</span> conda-forge
conda activate cf
mamba <span class="nb">install</span> <span class="nt">-c</span> conda-forge conda-build grayskull <span class="c"># grayskull not for this post, but other future submissions</span>
</code></pre></div></div>

<p>Is there an example I can start from and work by inference and similarity rather than first principles?</p>

<p><a href="https://github.com/conda-forge/libnetcdf-feedstock/blob/main/recipe/meta.yaml">libnetcdf-feedstock</a> may be an appropriate case to start from, even if more sophisticated than my case. Rather than strip down this libnetcdf recipe though, I work from the example in the staged-recipe and add, staying closer to <a href="https://conda-forge.org/docs/maintainer/adding_pkgs.html">contributing packages</a></p>

<p>I did bump into a couple of issues, but I got less issues than I thought to get a package compiling</p>

<p>The end result should be something like:</p>

<!-- NOTE: we need to use a 'raw' section; ninja2 things otherwise mess things up at rendering with Jekyll 
https://stackoverflow.com/questions/52324134/getting-an-liquid-exception-liquid-syntax-error-while-using-jekyll
-->

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="pi">{</span><span class="err">%</span> <span class="nv">set name = "moirai" %</span><span class="pi">}</span>
<span class="pi">{</span><span class="err">%</span> <span class="nv">set version = "1.1" %</span><span class="pi">}</span>

<span class="na">package</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">name|lower</span> <span class="pi">}}</span>
  <span class="na">version</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">version</span> <span class="pi">}}</span>

<span class="na">source</span><span class="pi">:</span>
  <span class="c1"># url: https://github.com/moirai/moirai/releases/download/{{ version }}/moirai-{{ version }}.tar.gz</span>
  <span class="c1"># and otherwise fall back to archive:</span>
  <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/csiro-hydroinformatics/moirai/archive/refs/tags/{{ version }}.tar.gz</span>
  <span class="na">sha256</span><span class="pi">:</span> <span class="s">b329353aee261ec42ddd57b7bb4ca5462186b2d132cdb2c9dacc9325899b85f3</span>

<span class="na">build</span><span class="pi">:</span>
  <span class="na">number</span><span class="pi">:</span> <span class="m">0</span>

<span class="na">requirements</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cmake</span>
    <span class="pi">-</span> <span class="s">make</span>  <span class="c1"># [not win]</span>
    <span class="c1"># - pkg-config  # [not win]</span>
    <span class="c1"># - gnuconfig  # [unix]</span>
    <span class="pi">-</span> <span class="pi">{{</span> <span class="nv">compiler('c')</span> <span class="pi">}}</span>
    <span class="pi">-</span> <span class="pi">{{</span> <span class="nv">compiler('cxx')</span> <span class="pi">}}</span>
  <span class="na">run</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">curl</span> <span class="c1"># [win]</span>
    <span class="pi">-</span> <span class="s">libgcc</span> <span class="c1"># [unix]</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">CMakeLists.txt</span>
  <span class="na">commands</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ls</span>

<span class="na">about</span><span class="pi">:</span>
  <span class="na">home</span><span class="pi">:</span> <span class="s">https://github.com/csiro-hydroinformatics/moirai</span>
  <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Manage</span><span class="nv"> </span><span class="s">C++</span><span class="nv"> </span><span class="s">objects</span><span class="nv"> </span><span class="s">lifetime</span><span class="nv"> </span><span class="s">when</span><span class="nv"> </span><span class="s">exposed</span><span class="nv"> </span><span class="s">through</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">C</span><span class="nv"> </span><span class="s">API'</span>
  <span class="na">description</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">This C++ library is designed to help handling C++ objects from so called opaque pointers, via a C API, featuring:</span>
      <span class="s">* counting references via the C API to C++ domain objects</span>
      <span class="s">* handle C++ class inheritance even via opaque pointers</span>
      <span class="s">* mechanism for resilience to incorrect type casts</span>
      <span class="s">* thread-safe design</span>
  <span class="na">license</span><span class="pi">:</span> <span class="s">BSD-3-Clause</span>
  <span class="na">license_family</span><span class="pi">:</span> <span class="s">BSD</span>
  <span class="na">license_file</span><span class="pi">:</span> <span class="s">LICENSE.txt</span>
  <span class="na">doc_url</span><span class="pi">:</span> <span class="s">https://github.com/csiro-hydroinformatics/moirai/blob/master/doc/Walkthrough.md</span>
  <span class="na">dev_url</span><span class="pi">:</span> <span class="s">https://github.com/csiro-hydroinformatics/moirai</span>

<span class="na">extra</span><span class="pi">:</span>
  <span class="na">recipe-maintainers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">jmp75</span></code></pre></figure>

<p>Note that you do need <code class="language-plaintext highlighter-rouge">make</code> as a build requirement besides <code class="language-plaintext highlighter-rouge">cmake</code>, otherwise you’d end up with :</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMake Error: CMake was unable to find a build program corresponding to "Unix Makefiles".  CMAKE_MAKE_PROGRAM is not set.  You probably need to select a different build tool.
CMake Error: CMAKE_C_COMPILER not set, after EnableLanguage
CMake Error: CMAKE_CXX_COMPILER not set, after EnableLanguage
</code></pre></div></div>

<p>build.sh:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># Build moirai.</span>

<span class="nb">mkdir</span> <span class="nt">-v</span> <span class="nt">-p</span> build
<span class="nb">cd </span>build

<span class="c"># May be needed for unit tests down the track?</span>
<span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:<span class="nv">$PREFIX</span>/lib

<span class="c"># cmake -DCMAKE_CXX_COMPILER=g++ -DCMAKE_C_COMPILER=gcc -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_PREFIX_PATH=/usr/local -DCMAKE_MODULE_PATH=/usr/local/share/cmake/Modules/ -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON ..</span>
cmake <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>Release <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">PREFIX</span><span class="k">}</span> <span class="nt">-DBUILD_SHARED_LIBS</span><span class="o">=</span>ON ../
make <span class="nt">-j</span> 2 <span class="nb">install</span>
<span class="c"># rm -rf ../build/ # not if we want to run the unit tests</span>
</code></pre></div></div>

<h2 id="building-locally-on-linux64">
<a class="anchor" href="#building-locally-on-linux64" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building locally on linux64</h2>

<p>Note: although it may have changed by the time you read this, at the time I write I may have to <code class="language-plaintext highlighter-rouge">export DOCKER_IMAGE=quay.io/condaforge/linux-anvil-cos7-x86_64</code> to force that image being used. See <a href="https://jmp75.github.io/work-blog/recipes/conda/conda-forge/2022/06/04/conda-packages-conda-forge.html">previous post</a>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda activate cf
<span class="nb">export </span><span class="nv">DOCKER_IMAGE</span><span class="o">=</span>quay.io/condaforge/linux-anvil-cos7-x86_64

<span class="nb">cd</span> ~/src/staged-recipes
python ./build-locally.py linux64
</code></pre></div></div>

<p>and the build seems OK…</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ touch /home/conda/staged-recipes/build_artifacts/conda-forge-build-done
</code></pre></div></div>

<h2 id="building-locally-on-win64">
<a class="anchor" href="#building-locally-on-win64" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building locally on win64</h2>

<p>Trying to run build-locally.py with the option win64 returns: <code class="language-plaintext highlighter-rouge">ValueError: only Linux/macOS configs currently supported, got win64</code></p>

<p>You’ll want to read or re-read the conda-forge documentation <a href="https://conda-forge.org/docs/maintainer/knowledge_base.html?#using-cmake">Using cmake</a> and <a href="https://conda-forge.org/docs/maintainer/knowledge_base.html?#particularities-on-windows">particularities on windows</a></p>

<p>Trying for <code class="language-plaintext highlighter-rouge">bld.bat</code>:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">REM Build moirai.</span>
<span class="c">@REM Credits: some material in this file are courtesy of Kavid Kent (ex Australian Bureau of Meteorology)</span>

<span class="nb">mkdir</span> <span class="kd">build</span>
<span class="nb">cd</span> <span class="kd">build</span>

<span class="c">@REM following may be unncessary</span>
<span class="kd">set</span> <span class="kd">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">%PREFIX%</span><span class="s2">\bin"</span><span class="o">;</span><span class="nv">%PATH%</span>

<span class="c">:: Configure using the CMakeFiles</span>
<span class="kd">cmake</span> <span class="na">-G </span><span class="s2">"</span><span class="nv">%CMAKE_GENERATOR%</span><span class="s2">"</span> <span class="se">^
</span>      <span class="na">-DCMAKE</span>_INSTALL_PREFIX:PATH<span class="o">=</span><span class="s2">"</span><span class="nv">%LIBRARY_PREFIX%</span><span class="s2">"</span> <span class="se">^
</span>      <span class="na">-DCMAKE</span>_PREFIX_PATH:PATH<span class="o">=</span><span class="s2">"</span><span class="nv">%LIBRARY_PREFIX%</span><span class="s2">"</span> <span class="se">^
</span>      <span class="na">-DCMAKE</span>_BUILD_TYPE:STRING<span class="o">=</span><span class="kd">Release</span> <span class="se">^
</span>      ..

<span class="k">if</span> <span class="nv">%errorlevel%</span> <span class="ow">neq</span> <span class="m">0</span> <span class="k">exit</span> <span class="m">1</span>
<span class="kd">msbuild</span> <span class="na">/p</span><span class="nl">:Configuration</span><span class="o">=</span><span class="kd">Release</span> <span class="na">/v</span><span class="nl">:q</span> <span class="na">/clp</span>:/v:q <span class="s2">"INSTALL.vcxproj"</span>
<span class="k">if</span> <span class="nv">%errorlevel%</span> <span class="ow">neq</span> <span class="m">0</span> <span class="k">exit</span> <span class="m">1</span>
<span class="c">@REM del *.*</span>
</code></pre></div></div>

<p>Since the local build script cannot emulate a win64 build, I am trying to set up on a Windows box and see what a <code class="language-plaintext highlighter-rouge">conda build</code> gives.</p>

<p>I first tried on my Windows desktop where I do have vs 2019 and 2022 installed. Not sure whether they can be used. <a href="https://conda-forge.org/docs/maintainer/knowledge_base.html?highlight=compiler%20cxx#local-testing">This section of the conda-forge doc</a> seem to suggest Microsoft Build Tools for Visual Studio 2017 is required, but the link to the Python wiki page on Windows compilers is covering many more versions, so this is rather confusing. See the Appendix for more details on what happens in this case.</p>

<p>Trying again on a windows machine, but installing visual studio build tools 2017.</p>

<p>After creating the conda environment <code class="language-plaintext highlighter-rouge">cf</code>, similar to the above on Linux:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> <span class="kd">c</span>:\src\staged<span class="na">-recipes</span>\recipes
<span class="kd">conda</span> <span class="kd">build</span> <span class="kd">moirai</span>
</code></pre></div></div>

<p>“mostly” works. for a minute or two it seems to freeze at a “number of files” line:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Packaging moirai
INFO:conda_build.build:Packaging moirai
Packaging moirai-1.1-h82bb817_0
INFO:conda_build.build:Packaging moirai-1.1-h82bb817_0
number of files: 11
</code></pre></div></div>

<p>then:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGO: UNKNOWN is not implemented yet!
PGO: UNKNOWN is not implemented yet!
Unknown format
Unknown format
Unknown format
Unknown format
   INFO: sysroot: 'C:/Windows/' files: '['zh-CN/winhlp32.exe.mui', 'zh-CN/twain_32.dll.mui', 'zh-CN/regedit.exe.mui', 'zh-CN/notepad.exe.mui']'

&lt;edit: snip&gt;

Importing conda-verify failed.  Please be sure to test your packages.  conda install conda-verify to make this message go away.
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">conda search -c conda-forge conda-verify</code> indeed returns something. Noted…</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;edit: snip&gt;

## Package Plan ##

  environment location: C:\Users\xxxyyy\Miniconda3\envs\cf\conda-bld\moirai_1654825059872\_test_env


The following NEW packages will be INSTALLED:

    ca-certificates: 2022.4.26-haa95532_0
    curl:            7.82.0-h2bbff1b_0
    libcurl:         7.82.0-h86230a5_0
    libssh2:         1.10.0-hcd4344a_0
    moirai:          1.1-h82bb817_0         local
    openssl:         1.1.1o-h2bbff1b_0
    vc:              14.2-h21ff451_1
    vs2015_runtime:  14.27.29016-h5e58377_2
    zlib:            1.2.12-h8cc25b3_2
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;edit: snip&gt;

set PREFIX=C:\Users\xxxyyy\Miniconda3\envs\cf\conda-bld\moirai_1654825059872\_test_env
set SRC_DIR=C:\Users\xxxyyy\Miniconda3\envs\cf\conda-bld\moirai_1654825059872\test_tmp
(cf) %SRC_DIR%&gt;call "%SRC_DIR%\conda_test_env_vars.bat"
(cf) %SRC_DIR%&gt;set "CONDA_SHLVL="   &amp;&amp;
(cf) %SRC_DIR%&gt;conda activate "%PREFIX%"
(%PREFIX%) %SRC_DIR%&gt;IF 0 NEQ 0 exit /B 1
(%PREFIX%) %SRC_DIR%&gt;call "%SRC_DIR%\run_test.bat"
(%PREFIX%) %SRC_DIR%&gt;ls
(%PREFIX%) %SRC_DIR%&gt;IF -1073741511 NEQ 0 exit /B 1
</code></pre></div></div>

<p>The latter fails because the command line <code class="language-plaintext highlighter-rouge">ls</code> borks with the error message (windows box error message) <code class="language-plaintext highlighter-rouge">ls.exe - Entry Point not found</code>. <code class="language-plaintext highlighter-rouge">where ls</code> returns <code class="language-plaintext highlighter-rouge">C:\Users\xxxyyy\Miniconda3\envs\cf\Library\usr\bin\ls.exe</code> so this is something that came from conda.</p>

<p>Taking a look at the resulting <code class="language-plaintext highlighter-rouge">moirai-1.1-h82bb817_0.tar.bz2</code> file, the content looks sensible (include header files, bin/moirai.dll)</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>info/hash_input.json
info/index.json
info/files
info/paths.json
info/about.json
info/git
info/recipe/build.sh
info/recipe/meta.yaml.template
info/licenses/LICENSE.txt
Library/include/moirai/extern_c_api_as_opaque.h
Library/include/moirai/extern_c_api_as_transparent.h
Library/include/moirai/setup_modifiers.h
Library/include/moirai/reference_handle_map_export.h
Library/include/moirai/error_reporting.h
Library/include/moirai/reference_handle.h
info/recipe/conda_build_config.yaml
info/recipe/meta.yaml
info/test/run_test.bat
info/recipe/bld.bat
Library/bin/moirai.dll
Library/include/moirai/reference_handle_test_helper.hpp
Library/include/moirai/opaque_pointers.hpp
Library/include/moirai/reference_type_converters.hpp
Library/include/moirai/reference_handle.hpp
</code></pre></div></div>

<h1 id="recapitulation-and-summary">
<a class="anchor" href="#recapitulation-and-summary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Recapitulation and summary</h1>

<p>In some respects I had less issues with this conda package than the “pure python” one, partly because of prior experience, but not entirely.</p>

<p>I may be in a decent place to submit this to the conda-forge/staged-recipe repository. I may hold off a bit though. First, the unit tests in moirai are not exercised by the meta.yaml file (or build scripts). Second, I may next look at setting up a conda channel to test managing conda dependencies, even if I see <code class="language-plaintext highlighter-rouge">moirai</code> as belonging to conda-forge rather than a private channel. Third, there are probably other things I need to tidy up.</p>

<p>To recapitulate on the essentials out of post:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create <span class="nt">-n</span> cf <span class="nv">python</span><span class="o">=</span>3.9 mamba <span class="nt">-c</span> conda-forge
conda activate cf
<span class="c"># grayskull not for this post, but other future submissions</span>
mamba <span class="nb">install</span> <span class="nt">-c</span> conda-forge conda-build conda-verify grayskull 
</code></pre></div></div>

<p>The draft conda recipe for <code class="language-plaintext highlighter-rouge">moirai</code> at this stage is available <a href="https://github.com/jmp75/staged-recipes/tree/a4c0e075230699b7f4dfd86e91f8f6b4ebca9af8/recipes/moirai">there</a></p>

<h1 id="acknowledgements">
<a class="anchor" href="#acknowledgements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Acknowledgements</h1>

<p>Some of the conda recipe trialled was influenced by prior work by Kavid Kent (ex Australian Bureau of Meteorology).</p>

<h1 id="appendices">
<a class="anchor" href="#appendices" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendices</h1>

<h2 id="appendix-if-missing-ms-build-tools-2017">
<a class="anchor" href="#appendix-if-missing-ms-build-tools-2017" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix: if missing ms build tools 2017</h2>

<p>If trying without having installed ms build tools 2017:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%SRC_DIR%&gt;CALL %BUILD_PREFIX%\etc\conda\activate.d\vs2017_get_vsinstall_dir.bat
Did not find VSINSTALLDIR
Windows SDK version found as: "10.0.19041.0"
The system cannot find the path specified.
Did not find VSINSTALLDIR
CMake Error at CMakeLists.txt:16 (PROJECT):
  Generator

    Visual Studio 15 2017 Win64

could not find any instance of Visual Studio.
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(cf) %SRC_DIR%&gt;set "SCRIPTS=%PREFIX%\Scripts"
(cf) %SRC_DIR%&gt;set "LIBRARY_PREFIX=%PREFIX%\Library"
(cf) %SRC_DIR%&gt;set "LIBRARY_BIN=%PREFIX%\Library\bin"
(cf) %SRC_DIR%&gt;set "LIBRARY_INC=%PREFIX%\Library\include"
(cf) %SRC_DIR%&gt;set "LIBRARY_LIB=%PREFIX%\Library\lib"

(cf) %SRC_DIR%&gt;set "c_compiler=vs2017"
(cf) %SRC_DIR%&gt;set "fortran_compiler=gfortran"
(cf) %SRC_DIR%&gt;set "vc=14"
(cf) %SRC_DIR%&gt;set "cxx_compiler=vs2017"
</code></pre></div></div>

<p>call C:\Users\xxxyyy\Miniconda3\Scripts\activate.bat</p>

<p>Note:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>base                  *  C:\Users\xxxyyy\Miniconda3\envs\cf
                         C:\Users\xxxyyy\Miniconda3\envs\cf\conda-bld\moirai_1654760072022\_build_env
                         C:\Users\xxxyyy\Miniconda3\envs\cf\conda-bld\moirai_1654760072022\_h_env
</code></pre></div></div>

<p>If I try to start with Visual Studio 2022 Developer Command Prompt v17.1.5. Then conda environment activation, still:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%SRC_DIR%&gt;CALL %BUILD_PREFIX%\etc\conda\activate.d\vs2017_get_vsinstall_dir.bat
Did not find VSINSTALLDIR
Windows SDK version found as: "10.0.19041.0"
**********************************************************************
** Visual Studio 2022 Developer Command Prompt v17.1.5
** Copyright (c) 2022 Microsoft Corporation
**********************************************************************
[ERROR:vcvars.bat] Toolset directory for version '14.16' was not found.
[ERROR:VsDevCmd.bat] *** VsDevCmd.bat encountered errors. Environment may be incomplete and/or incorrect. ***
[ERROR:VsDevCmd.bat] In an uninitialized command prompt, please 'set VSCMD_DEBUG=[value]' and then re-run
[ERROR:VsDevCmd.bat] vsdevcmd.bat [args] for additional details.
[ERROR:VsDevCmd.bat] Where [value] is:
[ERROR:VsDevCmd.bat]    1 : basic debug logging
[ERROR:VsDevCmd.bat]    2 : detailed debug logging
[ERROR:VsDevCmd.bat]    3 : trace level logging. Redirection of output to a file when using this level is recommended.
[ERROR:VsDevCmd.bat] Example: set VSCMD_DEBUG=3
[ERROR:VsDevCmd.bat]          vsdevcmd.bat &gt; vsdevcmd.trace.txt 2&gt;&amp;1
Did not find VSINSTALLDIR
CMake Error at CMakeLists.txt:16 (PROJECT):
  Generator

    Visual Studio 15 2017 Win64

  could not find any instance of Visual Studio.
-- Configuring incomplete, errors occurred!
</code></pre></div></div>

<h2 id="resources">
<a class="anchor" href="#resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources</h2>

<ul>
  <li><a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.85.6335&amp;rep=rep1&amp;type=pdf">Reference Counting in Library Design – Optionally and with Union-Find Optimization</a></li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jmp75/work-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/work-blog/recipes/conda/conda-forge/c++/2022/06/10/conda-packages-conda-forge-2.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/work-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/work-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/work-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Work-related posts for the so-called grey literature.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmp75" target="_blank" title="jmp75"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jmp_oz" target="_blank" title="jmp_oz"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

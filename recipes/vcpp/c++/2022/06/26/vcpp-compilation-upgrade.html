<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Upgrading a C++ streamflow compilation toolchain | J-M’s “lab notebook”</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Upgrading a C++ streamflow compilation toolchain" />
<meta name="author" content="<a href='https://github.com/jmp75'>J-M</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Moving a legacy Visual C++ 13 toolchain to Build Tools 2017" />
<meta property="og:description" content="Moving a legacy Visual C++ 13 toolchain to Build Tools 2017" />
<link rel="canonical" href="https://jmp75.github.io/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html" />
<meta property="og:url" content="https://jmp75.github.io/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html" />
<meta property="og:site_name" content="J-M’s “lab notebook”" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-26T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Upgrading a C++ streamflow compilation toolchain" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='https://github.com/jmp75'>J-M</a>"},"dateModified":"2022-06-26T00:00:00-05:00","datePublished":"2022-06-26T00:00:00-05:00","description":"Moving a legacy Visual C++ 13 toolchain to Build Tools 2017","headline":"Upgrading a C++ streamflow compilation toolchain","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmp75.github.io/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html"},"url":"https://jmp75.github.io/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/work-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmp75.github.io/work-blog/feed.xml" title="J-M's &quot;lab notebook&quot;" /><link rel="shortcut icon" type="image/x-icon" href="/work-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/work-blog/">J-M&#39;s &quot;lab notebook&quot;</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/work-blog/drafts/2022-06-XX-conda-channels-local-channel.html">Setting up a private conda channel - part 1</a><a class="page-link" href="/work-blog/about/">About Me</a><a class="page-link" href="/work-blog/search/">Search</a><a class="page-link" href="/work-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Upgrading a C++ streamflow compilation toolchain</h1><p class="page-description">Moving a legacy Visual C++ 13 toolchain to Build Tools 2017</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-26T00:00:00-05:00" itemprop="datePublished">
        Jun 26, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://github.com/jmp75'>J-M</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/work-blog/categories/#recipes">recipes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#VCPP">VCPP</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#C++">C++</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#background">Background</a></li>
<li class="toc-entry toc-h1"><a href="#current-status">Current status</a>
<ul>
<li class="toc-entry toc-h2"><a href="#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#high-level-options">High level options</a></li>
<li class="toc-entry toc-h1"><a href="#plan">Plan</a></li>
<li class="toc-entry toc-h1"><a href="#walkthrough">Walkthrough</a>
<ul>
<li class="toc-entry toc-h2"><a href="#boost">Boost</a>
<ul>
<li class="toc-entry toc-h3"><a href="#compile-from-source">Compile from source</a></li>
<li class="toc-entry toc-h3"><a href="#precompiled-boost-binaries">precompiled Boost binaries</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#moirai">Moirai</a></li>
<li class="toc-entry toc-h2"><a href="#netcdf">netCDF</a></li>
<li class="toc-entry toc-h2"><a href="#jsoncpp">jsoncpp</a></li>
<li class="toc-entry toc-h2"><a href="#yaml-cpp">yaml-cpp</a></li>
<li class="toc-entry toc-h2"><a href="#uchronia--datatypes">uchronia / datatypes</a></li>
<li class="toc-entry toc-h2"><a href="#swift">swift</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusion-and-next">Conclusion, and next</a></li>
</ul><h1 id="background">
<a class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h1>

<p>For years I’ve been contributing to and maintaining, at work, a <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard/">software stack for streamflow forecasting</a>. It is a stack with a core in C++. For a variety of reasons (licencing, habits, inertia) it is still compiled with the microsoft VCPP2013 toolchain. The most recent versions of some of the third party dependencies are starting to not be compiling with fthat 10 year old compiler, making maintenance more difficult.</p>

<p>This is not a particularly popular topic, but I am posting to at least organise and plan a migration.</p>

<h1 id="current-status">
<a class="anchor" href="#current-status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Current status</h1>

<p>On Windows, we are relying on vcxproj files. A fair bit of work went into being able to manage switching configurations more easily than via horrendous hard coded paths, which is the baffling default behavior with these files, or at least, was. The supposedly “user-friendly” GUIs to manage project settings foster an unholly mess unless users are on a very tight leash. The Readme at <a href="https://github.com/jmp75/vcpp-commons">vcpp-commons</a> includes instructions on how to set things up, and how to use it from visual c++ project files.</p>

<p>There are tools in the microsoft ecosystem to manage dependencies and configurations that were not existing 10 years ago. Here <a href="https://blog.conan.io/2021/02/10/Dependencies-Visual-Studio-C++-property-files.html">is one, Conan</a>, essentially doing what I put in place 10 years ago. There is also <a href="https://vcpkg.io/en/index.html">vcpkg</a> which I looked at a few years back. Be it as it may, we have a legacy that worked for a while, so we are likely to keep using it.</p>

<p>We are using property files (.props files) to manage centrally some definitions, so that our vcxproj files look like:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ImportGroup</span> <span class="na">Label=</span><span class="s">"PropertySheets"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props"</span> <span class="na">Condition=</span><span class="s">"exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')"</span> <span class="na">Label=</span><span class="s">"LocalAppDataPlatform"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(UserProfile)/vcpp_config.props"</span> <span class="na">Condition=</span><span class="s">"exists('$(UserProfile)/vcpp_config.props')"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ImportGroup&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;IncludePath&gt;</span>../include;$(LocalIncludePaths);$(IncludePath)<span class="nt">&lt;/IncludePath&gt;</span>
    <span class="nt">&lt;ReferencePath&gt;</span>$(VisualLeakDetectorLibPath);$(LocalLibraryPaths);$(ReferencePath)<span class="nt">&lt;/ReferencePath&gt;</span>
    <span class="nt">&lt;LibraryPath&gt;</span>$(VisualLeakDetectorLibPath);$(LocalLibraryPaths);$(LibraryPath)<span class="nt">&lt;/LibraryPath&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
  <span class="nt">&lt;ItemDefinitionGroup&gt;</span>
    <span class="nt">&lt;Link&gt;</span>
      <span class="nt">&lt;AdditionalLibraryDirectories&gt;</span>$(LocalLibraryPaths);%(AdditionalLibraryDirectories)<span class="nt">&lt;/AdditionalLibraryDirectories&gt;</span>
      <span class="nt">&lt;AdditionalDependencies&gt;</span>netcdf.lib;yaml-cpp.lib;moirai.lib;%(AdditionalDependencies)<span class="nt">&lt;/AdditionalDependencies&gt;</span>
      <span class="c">&lt;!--AdditionalDependencies&gt;vld.lib;%(AdditionalDependencies)&lt;/AdditionalDependencies--&gt;</span>
    <span class="nt">&lt;/Link&gt;</span>
  <span class="nt">&lt;/ItemDefinitionGroup&gt;</span>
</code></pre></div></div>

<p>A priori this is independent of the version of compiler used. A priori.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;PlatformToolset&gt;</span>v120<span class="nt">&lt;/PlatformToolset&gt;</span>
</code></pre></div></div>

<p>So, is it just a matter of just bulk replacing to <code class="language-plaintext highlighter-rouge">&lt;PlatformToolset&gt;v143&lt;/PlatformToolset&gt;</code>? Even if considering only the purely mechanistic aspect (notwithstanding users), probably not.</p>

<h2 id="dependencies">
<a class="anchor" href="#dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<p>The following figure gives an overview of the dependencies of the main DLLs. There are already several versions of the MS C runtimes, which is possible so long as libraries interact in a binary compatible way (C API). Usually, C++ level binary compatibility is not achievable. Never, in practice, so far as I recall.</p>

<p><img src="/work-blog/images/swift-library-dependencies-win.png" alt="" title="swift-library-dependencies-windows"></p>

<h1 id="high-level-options">
<a class="anchor" href="#high-level-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>High level options</h1>

<p>There are two main options to upgrade compilers</p>

<ul>
  <li>Give up on compiling using MS VCpp and migrate the MinGW toolchain (gcc). While it would be interesting to trial, the debugging facilities offered by the Microsoft tools and IDEs are a key value added for users.</li>
  <li>Upgrade the compilation to a newer version of MS vc++. A quick scan of what is available out there for the dependencies of the stack (boost, netcdf, etc.) suggests that the build tool chain 2017 is prevalent.</li>
</ul>

<p>Related to that are 2 key dependencies:</p>

<ul>
  <li>netcdf: does this need to be stuck at msvcr100.dll (not that it is much of a problem)</li>
  <li>boost: while boost is largely header only, it has a few libraries. These need to be brought to the same version of VCPP as that to compile our software, contrary to netcdf, because boost is C++, not C.</li>
</ul>

<p>Finally, some mostly orthogonal concerns</p>

<ul>
  <li>Move to use <code class="language-plaintext highlighter-rouge">cmake</code> to manage compilations, exactly as we do on Linux.</li>
  <li>Set up a CI/CD for compilation on windows.</li>
  <li>Automation of the migration to various versions of MSVCPP.</li>
</ul>

<h1 id="plan">
<a class="anchor" href="#plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plan</h1>

<p>The rest of this post will be a log of a “dry run” trying to migrate to MS build toolchain 2017 (vcpp v14.x to be determined). I’ll be capturing steps with a view to automate a CI/CD pipeline for windows soon, and also so that we can more easily adjust our target migration if I hit a blocker.</p>

<h1 id="walkthrough">
<a class="anchor" href="#walkthrough" aria-hidden="true"><span class="octicon octicon-link"></span></a>Walkthrough</h1>

<p>I already have a recent visual studio installed via my corporate software management system. I do need to install the Microsoft build tools for visual studio 2017. I note two things in what options this selects: the compiler version (perhaps known as platform version) is v141, and Windows SDK 10.0.17763.0.</p>

<h2 id="boost">
<a class="anchor" href="#boost" aria-hidden="true"><span class="octicon octicon-link"></span></a>Boost</h2>

<p>Read <a href="https://www.boost.org/doc/libs/1_79_0/more/getting_started/windows.html">Boost 1.79.0 for windows</a>.</p>

<h3 id="compile-from-source">
<a class="anchor" href="#compile-from-source" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compile from source</h3>

<p>I first tried to compile from source, out of curiosity, but this failed. For the record a summary follows.</p>

<p>Opening the Visual Studio 2017 Developer Command Prompt v15.0, then <code class="language-plaintext highlighter-rouge">7z x boost_1_79_0.7z</code>. Note that running <code class="language-plaintext highlighter-rouge">bootstrap</code> indicated that it was <code class="language-plaintext highlighter-rouge">Using 'vc143' toolset</code> so this may be an issue.</p>

<p>Then doing:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="kd">c</span>:\tmp\boost
<span class="kd">b2</span><span class="err">.exe</span>  <span class="na">--prefix</span><span class="o">=</span><span class="kd">c</span>:\tmp\boost
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:/src/tmp/boost_1_79_0/tools/build/src/build\targets.jam:617: in start-building from module targets
error: Recursion in main target references
error: the following target are being built currently:
error: ./forward -&gt; ./stage -&gt; ./stage-proper -&gt; ***libs/filesystem/build/stage*** -&gt; libs/filesystem/build/stage-dependencies -&gt; libs/log/build/stage -&gt; libs/log/build/stage-dependencies -&gt; ***libs/filesystem/build/stage***
</code></pre></div></div>

<p>Go for the prebuilt windows binaries then…</p>

<h3 id="precompiled-boost-binaries">
<a class="anchor" href="#precompiled-boost-binaries" aria-hidden="true"><span class="octicon octicon-link"></span></a>precompiled Boost binaries</h3>

<p><a href="https://www.boost.org/users/download/">https://www.boost.org/users/download/</a> leads to <a href="https://sourceforge.net/projects/boost/files/boost-binaries/1.79.0/boost_1_79_0-msvc-14.1-64.exe/download">boost_1_79_0-msvc-14.1-64.exe on sourceforge</a></p>

<p>Copying a subset of the libraries:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">set</span> <span class="kd">vcpp_ver</span><span class="o">=</span><span class="m">14</span>.1
<span class="kd">set</span> <span class="kd">boost_ver</span><span class="o">=</span><span class="m">1</span>_79_0
<span class="kd">set</span> <span class="kd">vcpp_ver_s</span><span class="o">=</span><span class="m">141</span>

<span class="kd">set</span> <span class="kd">src_root_dir</span><span class="o">=</span><span class="kd">C</span>:\local\boost_<span class="nv">%boost_ver%</span>
<span class="kd">set</span> <span class="kd">src_lib_dir</span><span class="o">=</span><span class="nv">%src_root_dir%</span>\lib64<span class="na">-msvc</span><span class="o">-</span><span class="nv">%vcpp_ver%</span>
<span class="kd">set</span> <span class="kd">src_header_dir</span><span class="o">=</span><span class="nv">%src_root_dir%</span>\boost

<span class="kd">set</span> <span class="kd">dest_root_dir</span><span class="o">=</span><span class="kd">C</span>:\local
<span class="kd">set</span> <span class="kd">dest_dbg_root_dir</span><span class="o">=</span><span class="kd">C</span>:\localdev
<span class="kd">set</span> <span class="kd">dest_lib_dir</span><span class="o">=</span><span class="nv">%dest_root_dir%</span>\libs\64
<span class="kd">set</span> <span class="kd">dest_dbg_lib_dir</span><span class="o">=</span><span class="nv">%dest_dbg_root_dir%</span>\libs\64
<span class="kd">set</span> <span class="kd">dest_header_dir</span><span class="o">=</span><span class="nv">%dest_root_dir%</span>\include
<span class="c">:: Cleanup or backup?</span>

<span class="nb">mkdir</span> <span class="nv">%dest_lib_dir%</span>

<span class="kd">set</span> <span class="kd">COPYOPTIONS</span><span class="o">=</span><span class="na">/Y /R /D

</span><span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_chrono<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\  <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_date_time<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_filesystem<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_system<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_thread<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\boost_regex<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>

<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_chrono<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_date_time<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_filesystem<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_system<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_thread<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%src_lib_dir%</span>\libboost_regex<span class="na">-vc</span><span class="nv">%vcpp_ver_s%</span><span class="o">*</span> <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>

<span class="c">:: header files</span>
<span class="nb">mkdir</span> <span class="nv">%dest_header_dir%</span>
<span class="kd">mv</span> <span class="nv">%src_header_dir%</span> <span class="nv">%dest_header_dir%</span>\
</code></pre></div></div>

<h2 id="moirai">
<a class="anchor" href="#moirai" aria-hidden="true"><span class="octicon octicon-link"></span></a>Moirai</h2>

<p><a href="https://github.com/csiro-hydroinformatics/MOIRAI">moirai</a> is the workorse for reference counting opaque pointers.</p>

<p>Open project with ms vstudio 2019 or more does offer an upgrade of the project. There are options to upgrade the windows sdk to a couple of versions.including the 10.0.17763.0 we noted. Note that the Platform toolset option however <strong>does not include v141</strong>.</p>

<p>So, a manual modification of the .vcxproj file is needed (or via project properties from vsstudio after opening the project, it is available this time)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;WindowsTargetPlatformVersion&gt;</span>10.0.17763.0<span class="nt">&lt;/WindowsTargetPlatformVersion&gt;</span>
    <span class="nt">&lt;PlatformToolset&gt;</span>v141<span class="nt">&lt;/PlatformToolset&gt;</span>
</code></pre></div></div>

<p>And this appears to compile.</p>

<h2 id="netcdf">
<a class="anchor" href="#netcdf" aria-hidden="true"><span class="octicon octicon-link"></span></a>netCDF</h2>

<p>Again may be interesting to compile from source, but not essential. <a href="https://docs.unidata.ucar.edu/netcdf-c/current/winbin.html">netcdf windows binaries document</a>. Appears to be compiled with vcpp 2017.</p>

<p>Downloading <a href="https://downloads.unidata.ucar.edu/netcdf-c/4.9.0/netCDF4.9.0-NC4-64.exe">netCDF4.9.0-NC4-64.exe</a></p>

<p>It appears to run on top of the v140 platform tools.That’s OK since this is a C API. Try. May see if we can compile from source with v141 target later.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">xcopy</span> <span class="kd">C</span>:\tmp\netcdf\bin\<span class="o">*</span>.dll <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="kd">C</span>:\tmp\netcdf\lib\<span class="o">*</span>.lib <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>

<span class="nb">mkdir</span> <span class="nv">%dest_header_dir%</span>\netcdf
<span class="nb">xcopy</span> <span class="kd">C</span>:\tmp\netcdf\include\<span class="o">*</span>.h <span class="nv">%dest_header_dir%</span>\netcdf\ <span class="nv">%COPYOPTIONS%</span>
</code></pre></div></div>

<h2 id="jsoncpp">
<a class="anchor" href="#jsoncpp" aria-hidden="true"><span class="octicon octicon-link"></span></a>jsoncpp</h2>

<p>I have a <a href="https://github.com/jmp75/jsoncpp/tree/custom/concise-project-file">fork of jsoncpp and a branch</a> with a customised .vcxproj file. Modifying with:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;PlatformToolset&gt;</span>v141<span class="nt">&lt;/PlatformToolset&gt;</span>
    <span class="nt">&lt;WindowsTargetPlatformVersion&gt;</span>10.0.17763.0<span class="nt">&lt;/WindowsTargetPlatformVersion&gt;</span>
</code></pre></div></div>

<p>And this compiles fine. Note that without <code class="language-plaintext highlighter-rouge">WindowsTargetPlatformVersion</code> in the project file, this failed to compile.</p>

<p>Now, how do I automate the building of these? TODO perhaps streamline the powershell script to deal with jsoncpp too. Even if likely very infrequent.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">set</span> <span class="kd">jsoncpp_srcdir</span><span class="o">=</span><span class="kd">C</span>:\src\jsoncpp
<span class="kd">set</span> <span class="kd">jsoncpp_builddir</span><span class="o">=</span><span class="nv">%jsoncpp_srcdir%</span>\makefiles\custom\x64
<span class="nb">xcopy</span> <span class="nv">%jsoncpp_builddir%</span>\Release\jsoncpp.dll <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%jsoncpp_builddir%</span>\Release\jsoncpp.lib <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="c">:: Debug also needed, likely. Know of very odd crashes when mixing debug/nondebug in the past. May not be the case anymore. </span>

<span class="nb">mkdir</span> <span class="nv">%dest_dbg_lib_dir%</span>
<span class="nb">xcopy</span> <span class="nv">%jsoncpp_builddir%</span>\Debug\jsoncpp.dll <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%jsoncpp_builddir%</span>\Debug\jsoncpp.lib <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%jsoncpp_builddir%</span>\Debug\jsoncpp.pdb <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>

<span class="kd">set</span> <span class="kd">robocopy_opt</span><span class="o">=</span><span class="na">/MIR /MT</span>:1 <span class="na">/R</span>:2 <span class="na">/NJS /NJH /NFL /NDL /XX
</span><span class="nb">robocopy</span> <span class="nv">%jsoncpp_srcdir%</span>\include\json <span class="nv">%dest_header_dir%</span>\json  <span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<h2 id="yaml-cpp">
<a class="anchor" href="#yaml-cpp" aria-hidden="true"><span class="octicon octicon-link"></span></a>yaml-cpp</h2>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">set</span> <span class="kd">yamlcpp_srcdir</span><span class="o">=</span><span class="kd">C</span>:\src\yaml<span class="na">-cpp
</span><span class="kd">set</span> <span class="kd">yamlcpp_builddir</span><span class="o">=</span><span class="nv">%yamlcpp_srcdir%</span>\vsproj\x64
<span class="nb">xcopy</span> <span class="nv">%yamlcpp_builddir%</span>\Release\yaml<span class="na">-cpp</span>.dll <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%yamlcpp_builddir%</span>\Release\yaml<span class="na">-cpp</span>.lib <span class="nv">%dest_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="c">:: Debug also needed, likely. Know of very odd crashes when mixing debug/nondebug in the past. May not be the case anymore. </span>
<span class="nb">xcopy</span> <span class="nv">%yamlcpp_builddir%</span>\Debug\yaml<span class="na">-cpp</span>.dll <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%yamlcpp_builddir%</span>\Debug\yaml<span class="na">-cpp</span>.lib <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>
<span class="nb">xcopy</span> <span class="nv">%yamlcpp_builddir%</span>\Debug\yaml<span class="na">-cpp</span>.pdb <span class="nv">%dest_dbg_lib_dir%</span>\ <span class="nv">%COPYOPTIONS%</span>

<span class="nb">robocopy</span> <span class="nv">%yamlcpp_srcdir%</span>\include\yaml<span class="na">-cpp </span><span class="nv">%dest_header_dir%</span>\yaml<span class="na">-cpp  </span><span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<h2 id="uchronia--datatypes">
<a class="anchor" href="#uchronia--datatypes" aria-hidden="true"><span class="octicon octicon-link"></span></a>uchronia / datatypes</h2>

<p><a href="https://github.com/csiro-hydroinformatics/uchronia-time-series">Uchronia - time series handling for ensembles simulations and forecasts in C++</a> is the bedrock for data handling in our stack.</p>

<p>At this point I do need to copy the files for the catch unit testing framework, from <a href="https://github.com/csiro-hydroinformatics/config-utils">config-utils</a>, which the unit tests rely on. I notice also a bit of a minor issue, because the unit tests compile against the deployed headers, not the ones from source. This may be a gotcha to watch for, because my <code class="language-plaintext highlighter-rouge">vcpp_settings.props</code> file is not set up for development mode compilation. Beware when setting a build pipeline.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">robocopy</span> <span class="kd">C</span>:\src\config<span class="na">-utils</span>\catch\include\catch <span class="nv">%dest_header_dir%</span>\catch  <span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<p>The compilation and deploymebnt of this is relatively streamlined by using a high level powershell script.</p>

<h2 id="swift">
<a class="anchor" href="#swift" aria-hidden="true"><span class="octicon octicon-link"></span></a>swift</h2>

<p>swift uses wila and its multithreading optimnisers. We need to install a complementary threadpool tool.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">robocopy</span> <span class="kd">C</span>:\src\threadpool\boost <span class="nv">%dest_header_dir%</span>\boost  <span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<p>Also uses in-house numerical header-only files:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">robocopy</span> <span class="kd">C</span>:\src\numerical<span class="na">-sl-cpp</span>\algorithm\include\sfsl <span class="nv">%dest_header_dir%</span>\sfsl  <span class="nv">%robocopy_opt%</span>
<span class="nb">robocopy</span> <span class="kd">C</span>:\src\numerical<span class="na">-sl-cpp</span>\math\include\sfsl <span class="nv">%dest_header_dir%</span>\sfsl  <span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error	C2039	'tuple': is not a member of 'boost::math' (compiling source file channel_muskingum_nl.cpp)	libswift	c:\src\swift\libswift\include\swift\channel_muskingum_nl.h	74	
</code></pre></div></div>

<p>Seems I just an explicit additional <code class="language-plaintext highlighter-rouge">#include &lt;boost/math/tools/tuple.hpp&gt;</code> now with a more recent version of boost.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">robocopy</span> <span class="kd">C</span>:\local\include_old\tclap <span class="nv">%dest_header_dir%</span>\tclap  <span class="nv">%robocopy_opt%</span>
<span class="c">:: &lt;!-- and for fogss later on: --&gt;</span>
<span class="nb">robocopy</span> <span class="kd">C</span>:\local\include_old\eigen3 <span class="nv">%dest_header_dir%</span>\eigen3  <span class="nv">%robocopy_opt%</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error	C2079	'outfile' uses undefined class 'std::basic_ofstream&lt;char,std::char_traits&lt;char&gt;&gt;'	swiftcl	c:\src\swift\applications\swiftcl\run_calibration.cpp	120	
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#include &lt;fstream&gt;</code> is now needed.</p>

<p>After that, unit tests are mostly as expected, a few watchpoint that may be red herring.</p>

<h1 id="conclusion-and-next">
<a class="anchor" href="#conclusion-and-next" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion, and next</h1>

<p>While it took a bit longer than ideal, so far, it looks rather straightforward and successful. Nothing was particularly risky a priori in this migration, but one is usually taken by a few surprises.</p>

<p>I am feeling the need for a more fully automated CI/CD. To be fair to myself, a fair bit of streamline already to build on. A challenge with the CI/CD, aside from some of the logistical cost of setting it up, probably on Azure Devops, is to define the artefacts it produces. Some artefacts the way they are currently would be better served as conda packages, but this is a larger scope.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jmp75/work-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/work-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/work-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/work-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Work-related posts for the so-called grey literature.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmp75" target="_blank" title="jmp75"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jmp_oz" target="_blank" title="jmp_oz"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

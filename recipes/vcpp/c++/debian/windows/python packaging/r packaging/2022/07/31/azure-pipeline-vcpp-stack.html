<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Azure devops CI pipeline for hydrologic forecasting software | J-M’s “lab notebook”</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Azure devops CI pipeline for hydrologic forecasting software" />
<meta name="author" content="<a href='https://github.com/jmp75'>J-M</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Azure devops pipeline for a software stack with c++, Python and R packages across multiple repositories." />
<meta property="og:description" content="Azure devops pipeline for a software stack with c++, Python and R packages across multiple repositories." />
<link rel="canonical" href="https://jmp75.github.io/work-blog/recipes/vcpp/c++/debian/windows/python%20packaging/r%20packaging/2022/07/31/azure-pipeline-vcpp-stack.html" />
<meta property="og:url" content="https://jmp75.github.io/work-blog/recipes/vcpp/c++/debian/windows/python%20packaging/r%20packaging/2022/07/31/azure-pipeline-vcpp-stack.html" />
<meta property="og:site_name" content="J-M’s “lab notebook”" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-31T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Azure devops CI pipeline for hydrologic forecasting software" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='https://github.com/jmp75'>J-M</a>"},"dateModified":"2022-07-31T00:00:00-05:00","datePublished":"2022-07-31T00:00:00-05:00","description":"Azure devops pipeline for a software stack with c++, Python and R packages across multiple repositories.","headline":"Azure devops CI pipeline for hydrologic forecasting software","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmp75.github.io/work-blog/recipes/vcpp/c++/debian/windows/python%20packaging/r%20packaging/2022/07/31/azure-pipeline-vcpp-stack.html"},"url":"https://jmp75.github.io/work-blog/recipes/vcpp/c++/debian/windows/python%20packaging/r%20packaging/2022/07/31/azure-pipeline-vcpp-stack.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/work-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmp75.github.io/work-blog/feed.xml" title="J-M's &quot;lab notebook&quot;" /><link rel="shortcut icon" type="image/x-icon" href="/work-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/work-blog/">J-M&#39;s &quot;lab notebook&quot;</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/work-blog/about/">About Me</a><a class="page-link" href="/work-blog/search/">Search</a><a class="page-link" href="/work-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Azure devops CI pipeline for hydrologic forecasting software</h1><p class="page-description">Azure devops pipeline for a software stack with c++, Python and R packages across multiple repositories.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-07-31T00:00:00-05:00" itemprop="datePublished">
        Jul 31, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://github.com/jmp75'>J-M</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/work-blog/categories/#recipes">recipes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#VCPP">VCPP</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#C++">C++</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#Debian">Debian</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#Windows">Windows</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#Python packaging">Python packaging</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#R packaging">R packaging</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#background">Background</a></li>
<li class="toc-entry toc-h1"><a href="#pipeline-inputs-and-outputs">Pipeline inputs and outputs</a>
<ul>
<li class="toc-entry toc-h2"><a href="#outputs">Outputs</a></li>
<li class="toc-entry toc-h2"><a href="#inputs">Inputs</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#walkthrough">Walkthrough</a>
<ul>
<li class="toc-entry toc-h2"><a href="#pipelines-code-repositories">Pipelines code repositories</a></li>
<li class="toc-entry toc-h2"><a href="#build-platforms">Build platforms</a></li>
<li class="toc-entry toc-h2"><a href="#checking-out-source-code">Checking out source code</a>
<ul>
<li class="toc-entry toc-h3"><a href="#using-personal-access-tokens-pat">Using Personal Access Tokens (PAT)</a></li>
<li class="toc-entry toc-h3"><a href="#a-gotcha-with-bitbucket-pats">A gotcha with Bitbucket PATs</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#building-c-code">Building C++ code</a>
<ul>
<li class="toc-entry toc-h3"><a href="#linux">Linux</a></li>
<li class="toc-entry toc-h3"><a href="#windows">Windows</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#unit-tests">Unit tests</a></li>
<li class="toc-entry toc-h2"><a href="#python-wheels-r-package-tarballs">Python wheels, R package tarballs</a>
<ul>
<li class="toc-entry toc-h3"><a href="#bash-on-windows-in-azure-pipelines-a-gotcha-with-backslash-directories">Bash on windows in Azure Pipelines: a gotcha with backslash directories</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#azure-artifacts">Azure Artifacts</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
<li class="toc-entry toc-h1"><a href="#appendix">Appendix</a>
<ul>
<li class="toc-entry toc-h2"><a href="#other-possibilities">Other possibilities</a></li>
<li class="toc-entry toc-h2"><a href="#resources">Resources</a></li>
</ul>
</li>
</ul><h1 id="background">
<a class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h1>

<p>For years I’ve been contributing to and maintaining, at work, a <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard/">software stack for streamflow forecasting</a>. Recently I explored <a href="https://jmp75.github.io/work-blog/recipes/vcpp/c++/2022/06/26/vcpp-compilation-upgrade.html">updating the compilation to a more recent Microsoft visual c++ compiler</a> in another post.</p>

<p>This post is an overview of the process to set up a build pipeline on Azure Devops. Given the fairly complicated codebase dealt with, quite a few technical aspects will be touched on, but not in great details for the sake of keeping it a blog post rather than a full report.</p>

<h1 id="pipeline-inputs-and-outputs">
<a class="anchor" href="#pipeline-inputs-and-outputs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pipeline inputs and outputs</h1>

<h2 id="outputs">
<a class="anchor" href="#outputs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Outputs</h2>

<ul>
  <li>Debian packages for installing C++ pre-compiled libraries and header files</li>
  <li>Windows DLLs of these C++ pre-compiled libraries, compiled with Microsoft Visual C++ 2019.</li>
  <li>Python wheels of packages accessing these C++ libraries</li>
  <li>R packages accessing these C++ libraries. Source tarballs for Linux, and binary packages for Windows</li>
  <li>Matlab functions accessing these C++ libraries</li>
</ul>

<p>Conda packages are an option for later - see appendix.</p>

<p>The outputs of this/these pipelines is used for installation as described for instance in <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard/blob/master/doc/install_windows.md">these instructions</a></p>

<h2 id="inputs">
<a class="anchor" href="#inputs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inputs</h2>

<p>These C++, Python and R packages are in the following source code repositories.</p>

<ul>
  <li>Third party libraries: boost libraries, netcdf, yaml-cpp and jsoncpp, threadpool, Catch headers.
    <ul>
      <li><a href="https://boost.org">Boost C++</a></li>
      <li><a href="https://www.unidata.ucar.edu/software/netcdf">netCDF4</a></li>
      <li><a href="https://github.com/csiro-hydroinformatics/yaml-cpp">yaml-cpp</a></li>
      <li><a href="https://github.com/csiro-hydroinformatics/jsoncpp">jsoncpp</a></li>
      <li><a href="https://github.com/csiro-hydroinformatics/threadpool">threadpool</a></li>
    </ul>
  </li>
  <li>Open source repositories with generic capabilities:
    <ul>
      <li>
<a href="https://github.com/csiro-hydroinformatics/rcpp-interop-commons">rcpp-interop-commons</a>: supporting C API interoperability with Python, R, etc.</li>
      <li>
<a href="https://github.com/csiro-hydroinformatics/moirai">moirai</a>: Manage C++ Objects’s lifetime when exposed through a C API</li>
      <li>
<a href="https://github.com/csiro-hydroinformatics/pyrefcount">pyrefcount</a>: Reference counting facilities for Python</li>
      <li>
<a href="https://github.com/csiro-hydroinformatics/wila">wila</a>: C++ header-only metaheuristics optimisation</li>
      <li><a href="https://github.com/csiro-hydroinformatics/config-utils">config-utils</a></li>
      <li><a href="https://github.com/csiro-hydroinformatics/efts">efts</a></li>
      <li><a href="https://github.com/csiro-hydroinformatics/efts-python">efts-python</a></li>
      <li>
<a href="https://github.com/csiro-hydroinformatics/mhplot">mhplot</a>: R visualisation for metaheuristics optimisation</li>
      <li>
<a href="https://github.com/csiro-hydroinformatics/uchronia-time-series">uchronia-time-series</a>:  time series handling for ensembles simulations and forecasts in C++</li>
    </ul>
  </li>
  <li>Closed source, domain specific:
    <ul>
      <li>swift: Streamflow Water Information Forecasting Tools</li>
      <li>FoGSS: A model for generated forecast guided stochastic scenarios of monthly streamflows out to 12 months</li>
      <li>A repository with semi-automated build scripts</li>
    </ul>
  </li>
</ul>

<p>Another repository worth mentioning even if I do not envisage it being used is <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a>. It contains some fairly sophisticated capabilities for generating language bindings on top of C APIs.</p>

<h1 id="walkthrough">
<a class="anchor" href="#walkthrough" aria-hidden="true"><span class="octicon octicon-link"></span></a>Walkthrough</h1>

<h2 id="pipelines-code-repositories">
<a class="anchor" href="#pipelines-code-repositories" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pipelines code repositories</h2>

<p>A clone of the the azure devops pipelines described in this post are now mirrored at:</p>

<ul>
  <li><a href="https://github.com/csiro-hydroinformatics/hydro-forecast-linux-pipeline">hydro-forecast-linux-pipeline</a></li>
  <li><a href="https://github.com/csiro-hydroinformatics/hydro-forecast-windows-pipeline">hydro-forecast-windows-pipeline</a></li>
</ul>

<h2 id="build-platforms">
<a class="anchor" href="#build-platforms" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build platforms</h2>

<p>For Linux I actually ended up building a Debian docker image on top of the <code class="language-plaintext highlighter-rouge">ubuntu-latest</code> image Azure Devops offers. This was partly an arbitrary choice (habits, and starting by reusing another pipeline).</p>

<p>For Windows, the <a href="https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md">windows-2019</a> image is more or less a given. Note that if I had chosen to, or had to, build with an older compiler version (for example, Python and conda on Windows I believe is at least recommending the 2017 toolchain currently), installing the Microsoft build toolchain would have been needed.</p>

<h2 id="checking-out-source-code">
<a class="anchor" href="#checking-out-source-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checking out source code</h2>

<p>There is a description of how to <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/multi-repo-checkout?view=azure-devops">check out multiple repositories in your pipeline</a>, which I may move to in the future but frankly felt cumbersome when I gave it a try, for that many repositories. Besides, I am starting from existing build scripts (bash or DOS) which I have an incentive to reuse.</p>

<p>Which brings us to dealing safely with checking out closed source code, requiring authentication.</p>

<h3 id="using-personal-access-tokens-pat">
<a class="anchor" href="#using-personal-access-tokens-pat" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Personal Access Tokens (PAT)</h3>

<p><strong>Disclaimer</strong>: I believe the following recipe to be in line with best practices, but it is up to you to decide.</p>

<p>When googling for the documentation, <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate">Use personal access tokens</a> tends to be what you land on, but this is more confusing than helpful. <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch#secret-variables">Set secret variables</a> contains the key recipe to set up a secret PAT and pass it on to a pipeline task. Assuming you already have a PAT that you defined in a pipeline variable <code class="language-plaintext highlighter-rouge">SWIFT_PAT</code>, for which you checked <code class="language-plaintext highlighter-rouge">Keep this value secret</code>, you need to map this value to pass it to the script checking out source code:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">call dos-setup.bat</span>
        <span class="s">call checkout.bat</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">SWIFT_PAT_ENV_VAR</span><span class="pi">:</span> <span class="s">$(SWIFT_PAT)</span> <span class="c1"># the recommended way to map to an env variable</span>
        <span class="c1"># NOTE: you cannot have the same name:</span>
        <span class="c1"># SWIFT_PAT: $(SWIFT_PAT) # &lt;-- fails with a circular definition issue.</span>
</code></pre></div></div>

<p>In your checkout.bat script you can retrieve <code class="language-plaintext highlighter-rouge">set MY_PAT=%SWIFT_PAT_ENV_VAR%</code> and use it as part of the URL portion e.g. <code class="language-plaintext highlighter-rouge">set MY_BITBUCKET_URL_ROOT=https://%YOUR_USERNAME%:%MY_PAT%@bitbucket.csiro.au/scm</code></p>

<h3 id="a-gotcha-with-bitbucket-pats">
<a class="anchor" href="#a-gotcha-with-bitbucket-pats" aria-hidden="true"><span class="octicon octicon-link"></span></a>A gotcha with Bitbucket PATs</h3>

<p>if your closed source code is on Bitbucket, the bitbucket documentation <a href="https://confluence.atlassian.com/bitbucketserver/personal-access-tokens-939515499.html">HTTP access tokens</a> is quite clear, but fails to document something. Bitbucket PAT generation tends to create them with slash characters “/” which is a special character for URLs so it <a href="https://stackoverflow.com/a/57732424/2752565">needs to be replace with “%2F”</a> before you use it as a value for your Azure Pipeline, otherwise you end up with an invalid URL error when checking out. Note also that <code class="language-plaintext highlighter-rouge">%2</code> is fraught when used in DOS scripts, but if you use the recipe above, you should not come across an issue with this.</p>

<h2 id="building-c-code">
<a class="anchor" href="#building-c-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building C++ code</h2>

<h3 id="linux">
<a class="anchor" href="#linux" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux</h3>

<p>Compilation on Linux is performed using <code class="language-plaintext highlighter-rouge">cmake</code>. The pipeline is not calling <code class="language-plaintext highlighter-rouge">cmake</code> and <code class="language-plaintext highlighter-rouge">make</code> commands directly, but building debian packages. One purpose of this build pipeline is to produce binary installable packages. It took me a fair bit of trial and error, two years ago, to find a suitable working recipe for Debian packaging of “my” libraries. There is documentation and plenty of examples out there, but plenty of variances in how it is done. An example can be found <a href="https://github.com/csiro-hydroinformatics/moirai/tree/experimental/debian">in the Moirai repository</a>, and the pipeline build commands are in <a href="https://github.com/csiro-hydroinformatics/hydro-forecast-linux-pipeline/blob/main/packages/build_debian_pkgs.sh">build_debian_pkgs.sh</a>.</p>

<h3 id="windows">
<a class="anchor" href="#windows" aria-hidden="true"><span class="octicon octicon-link"></span></a>Windows</h3>

<p>Compilation is done using microsoft visual c++ 2019, using visual studio solution files. Years ago, after enough frustrations invikig MSBuild.exe from DOS scripts, I moved to using powershell. Currently I am using the powershell <a href="https://github.com/deadlydog/Invoke-MsBuild">Invoke-MsBuild</a> as a third party tool to invoke compilation, rather than mdsbuild.exe directly. This is a nifty basis to build my own powershell module (not open source yet), with <code class="language-plaintext highlighter-rouge">cmdlet</code>s such as:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Install-SharedLibsMultiCfg</span><span class="w"> </span><span class="nt">-Solutions</span><span class="w"> </span><span class="nv">$lvlTwoSlns</span><span class="w"> </span><span class="nt">-LibsDirs</span><span class="w"> </span><span class="nv">$libsDirs</span><span class="w"> </span><span class="nt">-BuildPlatforms</span><span class="w"> </span><span class="nv">$buildPlatforms</span><span class="w"> </span><span class="nt">-BuildMode</span><span class="w"> </span><span class="nv">$buildMode</span><span class="w"> </span><span class="nt">-ToolsVersion</span><span class="w"> </span><span class="nv">$toolsVersion</span><span class="w"> </span><span class="nt">-LibNames</span><span class="w"> </span><span class="nv">$lvlTwoLibnames</span><span class="w">
</span></code></pre></div></div>

<p>which is roughly an equivalent of <code class="language-plaintext highlighter-rouge">make &amp;&amp; make install</code> on Linux. The script for the step is <a href="https://github.com/csiro-hydroinformatics/hydro-forecast-windows-pipeline/blob/main/build-stack.ps1">build-stack.ps1</a>, and the bulk of the runtime in the pipeline.</p>

<h2 id="unit-tests">
<a class="anchor" href="#unit-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unit tests</h2>

<p>All C++ unit tests are run on the Windows platform. (Debian to follow soon). There are some lessons learnt in setting these up in a pipeline, but for now most of the code remains closed source and may be explored in another post.</p>

<h2 id="python-wheels-r-package-tarballs">
<a class="anchor" href="#python-wheels-r-package-tarballs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Python wheels, R package tarballs</h2>

<p>The python package involved are “pure python” by design, and the wheels built are platform-agnostic and built only once on Linux (<a href="https://github.com/csiro-hydroinformatics/hydro-forecast-linux-pipeline/blob/main/packages/build_python_pkgs.sh">build_python_pkgs.sh</a>). Most packages do deal a lot with interoperability with native libraries with a C API, but this is done via cffi as a runtime step.</p>

<p>R source packages can be built on either platform. Except R Windows binary packages, which are much preferable for Windows. <a href="https://github.com/csiro-hydroinformatics/hydro-forecast-linux-pipeline/blob/main/packages/build_r_pkgs.sh">build_r_pkgs.sh</a> for the Linux pipeline builds these, also building tutorials (“vignettes”) which are contributing to the testing regime, notably for the interoperability with the native libraries of the stack.</p>

<p>I decided not to build the R tarballs on Windows, but try instead to downloadm, from the Window pipeline, the last output resulting the Linux pipeline. Partly for the sake of gaining know-how. I ended up with way more confusion and frustration with this than I anticipated, as reflected in my <a href="https://stackoverflow.com/a/73136309/2752565">stackoverflow answer</a> and <a href="https://jmp75.github.io/work-blog/azure/devops/microsoft/2022/07/27/azure-devops-negative-experience.html">previous blog post</a>.</p>

<p>Downloading the artifact from Windows is still done via a shell script <a href="https://github.com/csiro-hydroinformatics/hydro-forecast-windows-pipeline/blob/main/fetch-pkgs.sh">fetch-pkgs.sh</a>. The script is run mapping a <code class="language-plaintext highlighter-rouge">AZURE_DEVOPS_EXT_PAT</code> environment variable. The rather stunted <a href="https://docs.microsoft.com/en-us/azure/devops/cli/log-in-via-pat">Sign in with a personal access token (PAT)</a> page somewhat explains why this is used.</p>

<h3 id="bash-on-windows-in-azure-pipelines-a-gotcha-with-backslash-directories">
<a class="anchor" href="#bash-on-windows-in-azure-pipelines-a-gotcha-with-backslash-directories" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bash on windows in Azure Pipelines: a gotcha with backslash directories</h3>

<p>This is an occasion to point to an annoyance of backslashes as directory separators on Windows. I had defined a pipeline variable <code class="language-plaintext highlighter-rouge">linux_packages_dir: $(Build.ArtifactStagingDirectory)\swift_linux</code>, which would have been something like <code class="language-plaintext highlighter-rouge">D:\a\s\a\swift_linux</code>. In the script of a pipeline task <code class="language-plaintext highlighter-rouge">task: Bash@3</code>, if you use the variable evaluation <code class="language-plaintext highlighter-rouge">$(linux_packages_dir)</code> you loose the backslash separators. I had to rebuild the path and replace with forward slashes using the environment variable <code class="language-plaintext highlighter-rouge">BUILD_ARTIFACTSTAGINGDIRECTORY</code>, which is adding to the entropy.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">targetType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">inline'</span>
        <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># using $(linux_packages_dir) here fails; dir separators are lost.</span>
          <span class="s"># linux_packages_dir=$(linux_packages_dir)</span>
          <span class="s"># linux_packages_fwd_dir="${linux_packages_dir//\\//}"</span>
          <span class="s"># instead have to do:</span>
          <span class="s">linux_packages_fwd_dir="${BUILD_ARTIFACTSTAGINGDIRECTORY//\\//}/swift_linux"</span>
          <span class="s">./fetch-pkgs.sh ${linux_packages_fwd_dir}</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">AZURE_DEVOPS_EXT_PAT</span><span class="pi">:</span> <span class="s">$(AZ_ARTIFACT_DL_PAT)</span>
</code></pre></div></div>

<h2 id="azure-artifacts">
<a class="anchor" href="#azure-artifacts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Azure Artifacts</h2>

<p>Outputs are published as collections of files in a “Universal Package”. I have (had - may have changed) not found in the azure devops API way to query the artifacts for the version without downloading the whole artifact. A workaround is to publish two packages: a small one with the version number, and the real artifact.</p>

<p>To get a custom <code class="language-plaintext highlighter-rouge">$(Build.BuildNumber)</code>, and <code class="language-plaintext highlighter-rouge">r</code> is a counter reset to 1 every change of the major/minor versions, use <code class="language-plaintext highlighter-rouge">name: '0.1.$(Rev:r)'</code> on your pipeline. Then the publishing tasks can be:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">UniversalPackages@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish output bundle</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s">publish</span>
        <span class="na">publishDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)\release'</span>
        <span class="na">vstsFeedPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">my_project_name/hydro_forecast_win'</span>
        <span class="na">vstsFeedPackagePublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">swift_win'</span>
        <span class="na">versionOption</span><span class="pi">:</span> <span class="s">custom</span>
        <span class="na">versionPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.BuildNumber)'</span>
        <span class="na">packagePublishDescription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Windows</span><span class="nv"> </span><span class="s">packages</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">swift</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">co.'</span>

    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">UniversalPackages@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish output bundle version</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s">publish</span>
        <span class="na">publishDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)\version'</span>
        <span class="na">vstsFeedPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">my_project_name/hydro_forecast_win'</span>
        <span class="na">vstsFeedPackagePublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">swift_win_version'</span>
        <span class="na">versionOption</span><span class="pi">:</span> <span class="s">custom</span>
        <span class="na">versionPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.BuildNumber)'</span>
        <span class="na">packagePublishDescription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Version</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">windows</span><span class="nv"> </span><span class="s">swift</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">co.</span><span class="nv"> </span><span class="s">bundle'</span>

</code></pre></div></div>

<h1 id="conclusion">
<a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1>

<p>While the level of overall build streamlining was always adequate for this software stack, previous pipelines run on Jenkins could not be maintained. Azure Devops appearing to be the main corporate standard, we’ve trialed setting up Azure pipelines. Despite some notable user frustrations with the Azure Devops environment, its peculiarities and access arrangements, this should have substantial dividends to expand the user base and enable new projects.</p>

<h1 id="appendix">
<a class="anchor" href="#appendix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix</h1>

<h2 id="other-possibilities">
<a class="anchor" href="#other-possibilities" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other possibilities</h2>

<ul>
  <li>I have explored using conda packaging to distribute the whole software stack. This appears feasible but is a leap I am not ready to do for several reasons (time, resources and confirmed user demands being the main ones). There is a substantial learning curve, technical and in terms of governance of a private conda channel.</li>
  <li>Caching some of the downloaded test data and third party libraries.</li>
  <li>Publishing a linux debian docker image ready to use as a baseline.</li>
</ul>

<h2 id="resources">
<a class="anchor" href="#resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources</h2>

<p>URLs which may or may not have influenced this work:</p>

<ul>
  <li><a href="https://github.com/conda-forge/staged-recipes/blob/main/.azure-pipelines/azure-pipelines-win.yml">Conda-forge default azure pipeline</a></li>
  <li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml">azure devops pipeline variables</a></li>
  <li>
<a href="https://silentinstallhq.com/visual-studio-build-tools-2017-silent-install-how-to-guide">visual-studio-build-tools-2017-silent-install</a> may be handy if 2017 builds are needed e.g for conda.</li>
  <li><a href="https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md">Windows2019 image environment</a></li>
  <li><a href="https://github.com/marian-nmt/marian-dev/blob/master/azure-pipelines.yml">Azure pipelines for Marian NMT</a></li>
  <li><a href="https://marketplace.visualstudio.com/items?itemName=benjhuser.tfs-extensions-build-tasks">Trigger Build Task</a></li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jmp75/work-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/work-blog/recipes/vcpp/c++/debian/windows/python%20packaging/r%20packaging/2022/07/31/azure-pipeline-vcpp-stack.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/work-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/work-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/work-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Work-related posts for the so-called grey literature.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmp75" target="_blank" title="jmp75"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jmp_oz" target="_blank" title="jmp_oz"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

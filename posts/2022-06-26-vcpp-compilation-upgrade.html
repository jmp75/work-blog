<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.20">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="J-M">
<meta name="dcterms.date" content="2022-06-26">
<meta name="description" content="Moving a legacy Visual C++ 13 toolchain to Build Tools 2017">

<title>Upgrading a C++ streamflow compilation toolchain – J-M’s ‘lab notebook’</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-bb336a360afc1d7ae78ffae72a144868.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-516d19510a3495a2f5c04694115b7fde.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-dark-816ffc7d711b40eec17926d7a06ac7f2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-574be25b5a7772c3a765cc8590e29d11.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">J-M’s ‘lab notebook’</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jmp75"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jmp_oz"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Upgrading a C++ streamflow compilation toolchain</h1>
                  <div>
        <div class="description">
          Moving a legacy Visual C++ 13 toolchain to Build Tools 2017
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">recipes</div>
                <div class="quarto-category">VCPP</div>
                <div class="quarto-category">C++</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://github.com/jmp75">J-M</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 26, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#current-status" id="toc-current-status" class="nav-link" data-scroll-target="#current-status">Current status</a>
  <ul class="collapse">
  <li><a href="#dependencies" id="toc-dependencies" class="nav-link" data-scroll-target="#dependencies">Dependencies</a></li>
  </ul></li>
  <li><a href="#high-level-options" id="toc-high-level-options" class="nav-link" data-scroll-target="#high-level-options">High level options</a></li>
  <li><a href="#plan" id="toc-plan" class="nav-link" data-scroll-target="#plan">Plan</a></li>
  <li><a href="#walkthrough" id="toc-walkthrough" class="nav-link" data-scroll-target="#walkthrough">Walkthrough</a>
  <ul class="collapse">
  <li><a href="#boost" id="toc-boost" class="nav-link" data-scroll-target="#boost">Boost</a>
  <ul class="collapse">
  <li><a href="#compile-from-source" id="toc-compile-from-source" class="nav-link" data-scroll-target="#compile-from-source">Compile from source</a></li>
  <li><a href="#precompiled-boost-binaries" id="toc-precompiled-boost-binaries" class="nav-link" data-scroll-target="#precompiled-boost-binaries">precompiled Boost binaries</a></li>
  </ul></li>
  <li><a href="#moirai" id="toc-moirai" class="nav-link" data-scroll-target="#moirai">Moirai</a></li>
  <li><a href="#netcdf" id="toc-netcdf" class="nav-link" data-scroll-target="#netcdf">netCDF</a></li>
  <li><a href="#jsoncpp" id="toc-jsoncpp" class="nav-link" data-scroll-target="#jsoncpp">jsoncpp</a></li>
  <li><a href="#yaml-cpp" id="toc-yaml-cpp" class="nav-link" data-scroll-target="#yaml-cpp">yaml-cpp</a></li>
  <li><a href="#uchronia-datatypes" id="toc-uchronia-datatypes" class="nav-link" data-scroll-target="#uchronia-datatypes">uchronia / datatypes</a></li>
  <li><a href="#swift" id="toc-swift" class="nav-link" data-scroll-target="#swift">swift</a></li>
  </ul></li>
  <li><a href="#conclusion-and-next" id="toc-conclusion-and-next" class="nav-link" data-scroll-target="#conclusion-and-next">Conclusion, and next</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">
<script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    toggleBodyColorPrimary();
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        disableStylesheet(primaryStylesheets)
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const darkModeDefault = false;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>





<section id="background" class="level1">
<h1>Background</h1>
<p>For years I’ve been contributing to and maintaining, at work, a <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard/">software stack for streamflow forecasting</a>. It is a stack with a core in C++. For a variety of reasons (licencing, habits, inertia) it is still compiled with the microsoft VCPP2013 toolchain. The most recent versions of some of the third party dependencies are starting to not be compiling with fthat 10 year old compiler, making maintenance more difficult.</p>
<p>This is not a particularly popular topic, but I am posting to at least organise and plan a migration.</p>
</section>
<section id="current-status" class="level1">
<h1>Current status</h1>
<p>On Windows, we are relying on vcxproj files. A fair bit of work went into being able to manage switching configurations more easily than via horrendous hard coded paths, which is the baffling default behavior with these files, or at least, was. The supposedly “user-friendly” GUIs to manage project settings foster an unholly mess unless users are on a very tight leash. The Readme at <a href="https://github.com/jmp75/vcpp-commons">vcpp-commons</a> includes instructions on how to set things up, and how to use it from visual c++ project files.</p>
<p>There are tools in the microsoft ecosystem to manage dependencies and configurations that were not existing 10 years ago. Here <a href="https://blog.conan.io/2021/02/10/Dependencies-Visual-Studio-C++-property-files.html">is one, Conan</a>, essentially doing what I put in place 10 years ago. There is also <a href="https://vcpkg.io/en/index.html">vcpkg</a> which I looked at a few years back. Be it as it may, we have a legacy that worked for a while, so we are likely to keep using it.</p>
<p>We are using property files (.props files) to manage centrally some definitions, so that our vcxproj files look like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">ImportGroup</span><span class="ot"> Label=</span><span class="st">"PropertySheets"</span>&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Import</span><span class="ot"> Project=</span><span class="st">"$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props"</span><span class="ot"> Condition=</span><span class="st">"exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')"</span><span class="ot"> Label=</span><span class="st">"LocalAppDataPlatform"</span> /&gt;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Import</span><span class="ot"> Project=</span><span class="st">"$(UserProfile)/vcpp_config.props"</span><span class="ot"> Condition=</span><span class="st">"exists('$(UserProfile)/vcpp_config.props')"</span> /&gt;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">ImportGroup</span>&gt;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">PropertyGroup</span>&gt;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">IncludePath</span>&gt;../include;$(LocalIncludePaths);$(IncludePath)&lt;/<span class="kw">IncludePath</span>&gt;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ReferencePath</span>&gt;$(VisualLeakDetectorLibPath);$(LocalLibraryPaths);$(ReferencePath)&lt;/<span class="kw">ReferencePath</span>&gt;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">LibraryPath</span>&gt;$(VisualLeakDetectorLibPath);$(LocalLibraryPaths);$(LibraryPath)&lt;/<span class="kw">LibraryPath</span>&gt;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">PropertyGroup</span>&gt;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">ItemDefinitionGroup</span>&gt;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Link</span>&gt;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">AdditionalLibraryDirectories</span>&gt;$(LocalLibraryPaths);%(AdditionalLibraryDirectories)&lt;/<span class="kw">AdditionalLibraryDirectories</span>&gt;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">AdditionalDependencies</span>&gt;netcdf.lib;yaml-cpp.lib;moirai.lib;%(AdditionalDependencies)&lt;/<span class="kw">AdditionalDependencies</span>&gt;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!--AdditionalDependencies&gt;vld.lib;%(AdditionalDependencies)&lt;/AdditionalDependencies--&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Link</span>&gt;</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">ItemDefinitionGroup</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A priori this is independent of the version of compiler used. A priori.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">PlatformToolset</span>&gt;v120&lt;/<span class="kw">PlatformToolset</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So, is it just a matter of just bulk replacing to <code>&lt;PlatformToolset&gt;v143&lt;/PlatformToolset&gt;</code>? Even if considering only the purely mechanistic aspect (notwithstanding users), probably not.</p>
<section id="dependencies" class="level2">
<h2 class="anchored" data-anchor-id="dependencies">Dependencies</h2>
<p>The following figure gives an overview of the dependencies of the main DLLs. There are already several versions of the MS C runtimes, which is possible so long as libraries interact in a binary compatible way (C API). Usually, C++ level binary compatibility is not achievable. Never, in practice, so far as I recall.</p>
<p><img src="./images/swift-library-dependencies-win.png" title="swift-library-dependencies-windows" class="img-fluid"></p>
</section>
</section>
<section id="high-level-options" class="level1">
<h1>High level options</h1>
<p>There are two main options to upgrade compilers</p>
<ul>
<li>Give up on compiling using MS VCpp and migrate the MinGW toolchain (gcc). While it would be interesting to trial, the debugging facilities offered by the Microsoft tools and IDEs are a key value added for users.</li>
<li>Upgrade the compilation to a newer version of MS vc++. A quick scan of what is available out there for the dependencies of the stack (boost, netcdf, etc.) suggests that the build tool chain 2017 is prevalent.</li>
</ul>
<p>Related to that are 2 key dependencies:</p>
<ul>
<li>netcdf: does this need to be stuck at msvcr100.dll (not that it is much of a problem)</li>
<li>boost: while boost is largely header only, it has a few libraries. These need to be brought to the same version of VCPP as that to compile our software, contrary to netcdf, because boost is C++, not C.</li>
</ul>
<p>Finally, some mostly orthogonal concerns</p>
<ul>
<li>Move to use <code>cmake</code> to manage compilations, exactly as we do on Linux.</li>
<li>Set up a CI/CD for compilation on windows.</li>
<li>Automation of the migration to various versions of MSVCPP.</li>
</ul>
</section>
<section id="plan" class="level1">
<h1>Plan</h1>
<p>The rest of this post will be a log of a “dry run” trying to migrate to MS build toolchain 2017 (vcpp v14.x to be determined). I’ll be capturing steps with a view to automate a CI/CD pipeline for windows soon, and also so that we can more easily adjust our target migration if I hit a blocker.</p>
</section>
<section id="walkthrough" class="level1">
<h1>Walkthrough</h1>
<p>I already have a recent visual studio installed via my corporate software management system. I do need to install the Microsoft build tools for visual studio 2017. I note two things in what options this selects: the compiler version (perhaps known as platform version) is v141, and Windows SDK 10.0.17763.0.</p>
<section id="boost" class="level2">
<h2 class="anchored" data-anchor-id="boost">Boost</h2>
<p>Read <a href="https://www.boost.org/doc/libs/1_79_0/more/getting_started/windows.html">Boost 1.79.0 for windows</a>.</p>
<section id="compile-from-source" class="level3">
<h3 class="anchored" data-anchor-id="compile-from-source">Compile from source</h3>
<p>I first tried to compile from source, out of curiosity, but this failed. For the record a summary follows.</p>
<p>Opening the Visual Studio 2017 Developer Command Prompt v15.0, then <code>7z x boost_1_79_0.7z</code>. Note that running <code>bootstrap</code> indicated that it was <code>Using 'vc143' toolset</code> so this may be an issue.</p>
<p>Then doing:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> c:\tmp\boost</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>b2.exe  -<span class="at">-prefix</span>=c:\tmp\boost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>c:/src/tmp/boost_1_79_0/tools/build/src/build\targets.jam:617: in start-building from module targets
error: Recursion in main target references
error: the following target are being built currently:
error: ./forward -&gt; ./stage -&gt; ./stage-proper -&gt; ***libs/filesystem/build/stage*** -&gt; libs/filesystem/build/stage-dependencies -&gt; libs/log/build/stage -&gt; libs/log/build/stage-dependencies -&gt; ***libs/filesystem/build/stage***</code></pre>
<p>Go for the prebuilt windows binaries then…</p>
</section>
<section id="precompiled-boost-binaries" class="level3">
<h3 class="anchored" data-anchor-id="precompiled-boost-binaries">precompiled Boost binaries</h3>
<p><a href="https://www.boost.org/users/download/">https://www.boost.org/users/download/</a> leads to <a href="https://sourceforge.net/projects/boost/files/boost-binaries/1.79.0/boost_1_79_0-msvc-14.1-64.exe/download">boost_1_79_0-msvc-14.1-64.exe on sourceforge</a></p>
<p>Copying a subset of the libraries:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">vcpp_ver</span>=14.1</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">boost_ver</span>=1_79_0</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">vcpp_ver_s</span>=141</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">src_root_dir</span>=C:\local\boost_<span class="pp">%</span><span class="va">boost_ver</span><span class="pp">%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">src_lib_dir</span>=<span class="pp">%</span><span class="va">src_root_dir</span><span class="pp">%</span>\lib64-msvc-<span class="pp">%</span><span class="va">vcpp_ver</span><span class="pp">%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">src_header_dir</span>=<span class="pp">%</span><span class="va">src_root_dir</span><span class="pp">%</span>\boost</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">dest_root_dir</span>=C:\local</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">dest_dbg_root_dir</span>=C:\localdev</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">dest_lib_dir</span>=<span class="pp">%</span><span class="va">dest_root_dir</span><span class="pp">%</span>\libs\64</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">dest_dbg_lib_dir</span>=<span class="pp">%</span><span class="va">dest_dbg_root_dir</span><span class="pp">%</span>\libs\64</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">dest_header_dir</span>=<span class="pp">%</span><span class="va">dest_root_dir</span><span class="pp">%</span>\include</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">:: Cleanup or backup?</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">COPYOPTIONS</span>=/Y /R /D</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_chrono-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\  <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_date_time-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_filesystem-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_system-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_thread-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\boost_regex-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_chrono-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_date_time-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_filesystem-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_system-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_thread-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">src_lib_dir</span><span class="pp">%</span>\libboost_regex-vc<span class="pp">%</span><span class="va">vcpp_ver_s</span><span class="pp">%</span>* <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">:: header files</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>mv <span class="pp">%</span><span class="va">src_header_dir</span><span class="pp">%</span> <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span><span class="sc">\</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="moirai" class="level2">
<h2 class="anchored" data-anchor-id="moirai">Moirai</h2>
<p><a href="https://github.com/csiro-hydroinformatics/MOIRAI">moirai</a> is the workorse for reference counting opaque pointers.</p>
<p>Open project with ms vstudio 2019 or more does offer an upgrade of the project. There are options to upgrade the windows sdk to a couple of versions.including the 10.0.17763.0 we noted. Note that the Platform toolset option however <strong>does not include v141</strong>.</p>
<p>So, a manual modification of the .vcxproj file is needed (or via project properties from vsstudio after opening the project, it is available this time)</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">WindowsTargetPlatformVersion</span>&gt;10.0.17763.0&lt;/<span class="kw">WindowsTargetPlatformVersion</span>&gt;</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PlatformToolset</span>&gt;v141&lt;/<span class="kw">PlatformToolset</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And this appears to compile.</p>
</section>
<section id="netcdf" class="level2">
<h2 class="anchored" data-anchor-id="netcdf">netCDF</h2>
<p>Again may be interesting to compile from source, but not essential. <a href="https://docs.unidata.ucar.edu/netcdf-c/current/winbin.html">netcdf windows binaries document</a>. Appears to be compiled with vcpp 2017.</p>
<p>Downloading <a href="https://downloads.unidata.ucar.edu/netcdf-c/4.9.0/netCDF4.9.0-NC4-64.exe">netCDF4.9.0-NC4-64.exe</a></p>
<p>It appears to run on top of the v140 platform tools.That’s OK since this is a C API. Try. May see if we can compile from source with v141 target later.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> C:\tmp\netcdf\bin\*.dll <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> C:\tmp\netcdf\lib\*.lib <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\netcdf</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> C:\tmp\netcdf\include\*.h <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\netcdf\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="jsoncpp" class="level2">
<h2 class="anchored" data-anchor-id="jsoncpp">jsoncpp</h2>
<p>I have a <a href="https://github.com/jmp75/jsoncpp/tree/custom/concise-project-file">fork of jsoncpp and a branch</a> with a customised .vcxproj file. Modifying with:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PlatformToolset</span>&gt;v141&lt;/<span class="kw">PlatformToolset</span>&gt;</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">WindowsTargetPlatformVersion</span>&gt;10.0.17763.0&lt;/<span class="kw">WindowsTargetPlatformVersion</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And this compiles fine. Note that without <code>WindowsTargetPlatformVersion</code> in the project file, this failed to compile.</p>
<p>Now, how do I automate the building of these? TODO perhaps streamline the powershell script to deal with jsoncpp too. Even if likely very infrequent.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">jsoncpp_srcdir</span>=C:\src\jsoncpp</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">jsoncpp_builddir</span>=<span class="pp">%</span><span class="va">jsoncpp_srcdir</span><span class="pp">%</span>\makefiles\custom\x64</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">jsoncpp_builddir</span><span class="pp">%</span>\Release\jsoncpp.dll <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">jsoncpp_builddir</span><span class="pp">%</span>\Release\jsoncpp.lib <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">:: Debug also needed, likely. Know of very odd crashes when mixing debug/nondebug in the past. May not be the case anymore. </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">jsoncpp_builddir</span><span class="pp">%</span>\Debug\jsoncpp.dll <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">jsoncpp_builddir</span><span class="pp">%</span>\Debug\jsoncpp.lib <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">jsoncpp_builddir</span><span class="pp">%</span>\Debug\jsoncpp.pdb <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">robocopy_opt</span>=/MIR /MT:1 /R:2 /NJS /NJH /NFL /NDL /XX</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>robocopy <span class="pp">%</span><span class="va">jsoncpp_srcdir</span><span class="pp">%</span>\include\json <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\json  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="yaml-cpp" class="level2">
<h2 class="anchored" data-anchor-id="yaml-cpp">yaml-cpp</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">yamlcpp_srcdir</span>=C:\src\yaml-cpp</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="va">yamlcpp_builddir</span>=<span class="pp">%</span><span class="va">yamlcpp_srcdir</span><span class="pp">%</span>\vsproj\x64</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">yamlcpp_builddir</span><span class="pp">%</span>\Release\yaml-cpp.dll <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">yamlcpp_builddir</span><span class="pp">%</span>\Release\yaml-cpp.lib <span class="pp">%</span><span class="va">dest_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">:: Debug also needed, likely. Know of very odd crashes when mixing debug/nondebug in the past. May not be the case anymore. </span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">yamlcpp_builddir</span><span class="pp">%</span>\Debug\yaml-cpp.dll <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">yamlcpp_builddir</span><span class="pp">%</span>\Debug\yaml-cpp.lib <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="kw">xcopy</span> <span class="pp">%</span><span class="va">yamlcpp_builddir</span><span class="pp">%</span>\Debug\yaml-cpp.pdb <span class="pp">%</span><span class="va">dest_dbg_lib_dir</span><span class="pp">%</span>\ <span class="pp">%</span><span class="va">COPYOPTIONS</span><span class="pp">%</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>robocopy <span class="pp">%</span><span class="va">yamlcpp_srcdir</span><span class="pp">%</span>\include\yaml-cpp <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\yaml-cpp  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="uchronia-datatypes" class="level2">
<h2 class="anchored" data-anchor-id="uchronia-datatypes">uchronia / datatypes</h2>
<p><a href="https://github.com/csiro-hydroinformatics/uchronia-time-series">Uchronia - time series handling for ensembles simulations and forecasts in C++</a> is the bedrock for data handling in our stack.</p>
<p>At this point I do need to copy the files for the catch unit testing framework, from <a href="https://github.com/csiro-hydroinformatics/config-utils">config-utils</a>, which the unit tests rely on. I notice also a bit of a minor issue, because the unit tests compile against the deployed headers, not the ones from source. This may be a gotcha to watch for, because my <code>vcpp_settings.props</code> file is not set up for development mode compilation. Beware when setting a build pipeline.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>robocopy C:\src\config-utils\catch\include\catch <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\catch  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The compilation and deploymebnt of this is relatively streamlined by using a high level powershell script.</p>
</section>
<section id="swift" class="level2">
<h2 class="anchored" data-anchor-id="swift">swift</h2>
<p>swift uses wila and its multithreading optimnisers. We need to install a complementary threadpool tool.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>robocopy C:\src\threadpool\boost <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\boost  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Also uses in-house numerical header-only files:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>robocopy C:\src\numerical-sl-cpp\algorithm\include\sfsl <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\sfsl  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>robocopy C:\src\numerical-sl-cpp\math\include\sfsl <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\sfsl  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>Error   C2039   'tuple': is not a member of 'boost::math' (compiling source file channel_muskingum_nl.cpp)  libswift    c:\src\swift\libswift\include\swift\channel_muskingum_nl.h  74  </code></pre>
<p>Seems I just an explicit additional <code>#include &lt;boost/math/tools/tuple.hpp&gt;</code> now with a more recent version of boost.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bat code-with-copy"><code class="sourceCode dosbat"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>robocopy C:\local\include_old\tclap <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\tclap  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">:: </span><span class="er">&lt;</span><span class="co">!-- and for fogss later on: --</span><span class="er">&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>robocopy C:\local\include_old\eigen3 <span class="pp">%</span><span class="va">dest_header_dir</span><span class="pp">%</span>\eigen3  <span class="pp">%</span><span class="va">robocopy_opt</span><span class="pp">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>Error   C2079   'outfile' uses undefined class 'std::basic_ofstream&lt;char,std::char_traits&lt;char&gt;&gt;'   swiftcl c:\src\swift\applications\swiftcl\run_calibration.cpp   120 </code></pre>
<p><code>#include &lt;fstream&gt;</code> is now needed.</p>
<p>After that, unit tests are mostly as expected, a few watchpoint that may be red herring.</p>
</section>
</section>
<section id="conclusion-and-next" class="level1">
<h1>Conclusion, and next</h1>
<p>While it took a bit longer than ideal, so far, it looks rather straightforward and successful. Nothing was particularly risky a priori in this migration, but one is usually taken by a few surprises.</p>
<p>I am feeling the need for a more fully automated CI/CD. To be fair to myself, a fair bit of streamline already to build on. A challenge with the CI/CD, aside from some of the logistical cost of setting it up, probably on Azure Devops, is to define the artefacts it produces. Some artefacts the way they are currently would be better served as conda packages, but this is a larger scope.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(darkModeDefault) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    }
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jmp75\.github\.io\/work-blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2022 Jean-Michel Perraud. Except where otherwise noted, all text and images licensed CC-BY-NC 4.0.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>
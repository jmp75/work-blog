<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.165">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="J-M">
<meta name="dcterms.date" content="2022-09-03">
<meta name="description" content="Generate language binging for Python, R and other wrappers on top of a C API">

<title>J-M’s ‘lab notebook’ - Generate programming language bindings to a C API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">J-M’s ‘lab notebook’</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jmp75"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jmp_oz"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Generate programming language bindings to a C API</h1>
                  <div>
        <div class="description">
          Generate language binging for Python, R and other wrappers on top of a C API
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">code generation</div>
                <div class="quarto-category">interop</div>
                <div class="quarto-category">C++</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://github.com/jmp75">J-M</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 3, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#history" id="toc-history" class="nav-link" data-scroll-target="#history">History</a></li>
  </ul></li>
  <li><a href="#glue-code-generation---context-and-review" id="toc-glue-code-generation---context-and-review" class="nav-link" data-scroll-target="#glue-code-generation---context-and-review">Glue code generation - context and review</a>
  <ul class="collapse">
  <li><a href="#foreword---google-search" id="toc-foreword---google-search" class="nav-link" data-scroll-target="#foreword---google-search">Foreword - Google search</a></li>
  <li><a href="#brief-scan-of-the-state-of-the-art" id="toc-brief-scan-of-the-state-of-the-art" class="nav-link" data-scroll-target="#brief-scan-of-the-state-of-the-art">Brief scan of the state of the art</a></li>
  </ul></li>
  <li><a href="#sample-usage" id="toc-sample-usage" class="nav-link" data-scroll-target="#sample-usage">Sample usage</a>
  <ul class="collapse">
  <li><a href="#c-api" id="toc-c-api" class="nav-link" data-scroll-target="#c-api">C API</a></li>
  <li><a href="#outline-generating-the-python-glue-code" id="toc-outline-generating-the-python-glue-code" class="nav-link" data-scroll-target="#outline-generating-the-python-glue-code">Outline generating the python glue code</a>
  <ul class="collapse">
  <li><a href="#gen_py_common.fsx" id="toc-gen_py_common.fsx" class="nav-link" data-scroll-target="#gen_py_common.fsx">gen_py_common.fsx</a></li>
  <li><a href="#back-to-the-main-script" id="toc-back-to-the-main-script" class="nav-link" data-scroll-target="#back-to-the-main-script">Back to the main script</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#architecture" id="toc-architecture" class="nav-link" data-scroll-target="#architecture">Architecture</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figure class="figure">
<img src="./images/c-api-gen/codegen-wrappers.svg" title="Glue code generation" class="img-fluid figure-img">
</figure>
<p></p><figcaption class="figure-caption">gluecode-generation</figcaption><p></p>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The codebase <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/">Uchronia - time series handling for ensembles simulations and forecasts in C++</a> comprises a C++ core, and a C Application Programming Interface with Python, R, Matlab (and other) bindings. This is part of a <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard">software stack for streamflow forecasting</a>. Some elements of the software stack similar to Uchronia have large C APIs. Even with a very stable C API (and they often were not at some point), it is mind-numbing, inefficient and bug-prone to generate <a href="https://en.wikipedia.org/wiki/Language_binding">language bindings (glue code)</a> manually.</p>
<p>What I am writing about in this post is utility code for <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">interoperability code generation</a> that grew out of scientific software, and perhaps should have advertised in its own right.</p>
<section id="history" class="level2">
<h2 class="anchored" data-anchor-id="history">History</h2>
<p>In 2014 after settling for C++ for a modelling core. I had R, Matlab and Python users, some need to interop with C# code. And some constraints on using different C++ compilers in the stack. So I decided on designing C APIs, the <em>lingua franca</em> of in-process interop. I had some prior exposure to the Mono C core and interop with R. But not extensive first hand.</p>
<p>My first port of call for glue code was a no-brainer: <a href="https://www.swig.org/">SWIG</a>, which I first encountered in an internship in… 1997. I did not document my tribulations in details, but I encountered many difficulties when testing feasibility. Basically, I concluded that SWIG was just not a good fit for a C API like mine, especially one with opaque pointers (<code>void*</code>).</p>
<p>There were other offering for code generation for R, or Python. But apart from SWIG, I do not recall locating any suitable glue code generation for multiple target languages. I may revisit in more details the tribulations in another post, but this was the reason for the inception of <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a>.</p>
</section>
</section>
<section id="glue-code-generation---context-and-review" class="level1">
<h1>Glue code generation - context and review</h1>
<section id="foreword---google-search" class="level2">
<h2 class="anchored" data-anchor-id="foreword---google-search">Foreword - Google search</h2>
<p>Before starting this post, I wanted to check out what was the state of play out there and I was googling using the terms “generate bindings for a C API”. Our <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a> was coming up in the first few items. I thought Google was biasing the search given the wealth of information it has, I mean, come on, there must be thousands of similar endeavours out there. No way.</p>
<p>But, after some friends help and simulating searches from another geolocation, it seems Google is not cheating.</p>
<p>Not sure what to make of this yet. Oh, and searching “generating binding to a c api” instead of “generating bindings to a c api” wields a different list…</p>
<p>Anyway, a quick review before looking at <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a>.</p>
</section>
<section id="brief-scan-of-the-state-of-the-art" class="level2">
<h2 class="anchored" data-anchor-id="brief-scan-of-the-state-of-the-art">Brief scan of the state of the art</h2>
<p>There is an excellent post <a href="https://floooh.github.io/2020/08/23/sokol-bindgen.html">Automatic Language Bindings</a> by <a href="https://github.com/floooh">Andrew Weissflog</a>, which I recommend. Many statements and observations resonate with me. Related directly or indirectly to the post above (I intuit) I found <a href="https://github.com/bottlenoselabs/c2cs">C2CS</a>. I am very intrigued by their use of an abstract syntax tree (AST), I think. My approach was more crude (but perhaps pragmatic).</p>
<p>From the Rust community <a href="https://users.rust-lang.org/t/creating-bindings-to-c-apis/23819">this thread</a> and <a href="https://github.com/rust-lang/rust-bindgen">rust-bindgen</a></p>
<p>A wealth of resources in <a href="http://lua-users.org/wiki/BindingCodeToLua">BindingCodeToLua</a></p>
<p><a href="https://github.com/pybind/pybind11">pybind11</a> is something I already looked at 3 years ago in <a href="https://medium.com/@jean.michel.perraud/using-pybind11-for-cross-module-c-api-bindings-5e50925d5684">this post</a>. I probably would have settled on it if it was purely about Python bindings, directly to the C++ code.</p>
</section>
</section>
<section id="sample-usage" class="level1">
<h1>Sample usage</h1>
<p>Let’s start with a sample usage. This is based on code that has evolved over time rather than something purely didactic, but should give an idea of the process. I may update this post if I reshape things to be more didactic.</p>
<section id="c-api" class="level2">
<h2 class="anchored" data-anchor-id="c-api">C API</h2>
<p>The codebase uchronia has a <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/datatypes/include/datatypes/extern_c_api.h">C API with functions</a> such as:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    DATATYPES_API <span class="dt">char</span><span class="op">**</span> GetEnsembleDatasetDataIdentifiers<span class="op">(</span>ENSEMBLE_DATA_SET_PTR dataLibrary<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> size<span class="op">);</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    DATATYPES_API ENSEMBLE_FORECAST_TIME_SERIES_PTR CreateEnsembleForecastTimeSeries<span class="op">(</span>date_time_to_second start<span class="op">,</span> <span class="dt">int</span> length<span class="op">,</span> <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> timeStepName<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    DATATYPES_API <span class="dt">void</span> GetTimeSeriesValues<span class="op">(</span>TIME_SERIES_PTR timeSeries<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span> values<span class="op">,</span> <span class="dt">int</span> arrayLength<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/python/uchronia/uchronia/wrap/uchronia_wrap_generated.py">low-level Python binding generated</a> from parsing this C API result in the following type of code. Note that opaque pointers such as <code>ENSEMBLE_DATA_SET_PTR</code> have corresponding higher level Python class equivalents such as <code>TimeSeriesLibrary</code>, even in the “low-level” glue code.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> GetEnsembleDatasetDataIdentifiers_py(dataLibrary:<span class="st">'TimeSeriesLibrary'</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    dataLibrary_xptr <span class="op">=</span> wrap_as_pointer_handle(dataLibrary)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    size <span class="op">=</span> marshal.new_int_scalar_ptr()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> uchronia_so.GetEnsembleDatasetDataIdentifiers(dataLibrary_xptr.ptr, size)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> charp_array_to_py(values, size[<span class="dv">0</span>], <span class="va">True</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> CreateEnsembleForecastTimeSeries_py(start:datetime, length:<span class="bu">int</span>, timeStepName:<span class="bu">str</span>) <span class="op">-&gt;</span> <span class="st">'EnsembleForecastTimeSeries'</span>:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># glue code</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> GetTimeSeriesValues_py(timeSeries:<span class="st">'TimeSeries'</span>, values:np.ndarray, arrayLength:<span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># glue code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For information, the equivalent generated glue code for an R package <code>uchronia</code> are in files <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/R/pkgs/uchronia/src/rcpp_generated.cpp">src/rcpp_generated.cpp</a> and <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/R/pkgs/uchronia/R/uchronia-pkg-wrap-generated.r">R/uchronia-pkg-wrap-generated.r</a>.</p>
</section>
<section id="outline-generating-the-python-glue-code" class="level2">
<h2 class="anchored" data-anchor-id="outline-generating-the-python-glue-code">Outline generating the python glue code</h2>
<p>See the <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">wrapper generator c-api-wrapper-generation</a>. The README.md has setup instructions for dotnet, if need be.</p>
<p>There is a history behind why the conversion engine runs on .NET (and is written in C#), but I will not dwell on it in this post. Note that as of August 2022, even on Linux packages from the .NET ecosystem are readily available from Microsoft or even Ubuntu official package repositories.</p>
<p>If you have dotnet installed <code>dotnet --info</code> returns as of August 2022:</p>
<pre class="text"><code>.NET SDK (reflecting any global.json):
 Version:   6.0.302
 Commit:    c857713418

Runtime Environment:
 OS Name:     debian
 OS Version:  11
 OS Platform: Linux
 RID:         debian.11-x64
 Base Path:   /usr/share/dotnet/sdk/6.0.302/

global.json file:
  Not found

Host:
  Version:      6.0.7
  Architecture: x64
  Commit:       0ec02c8c96

.NET SDKs installed:
  6.0.302 [/usr/share/dotnet/sdk]

.NET runtimes installed:
  Microsoft.AspNetCore.App 6.0.7 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App]
  Microsoft.NETCore.App 3.1.27 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
  Microsoft.NETCore.App 6.0.7 [/usr/share/dotnet/shared/Microsoft.NETCore.App]</code></pre>
<p>The codegen engine is C#, and we’ll give an overview later. Compiling it is done like so:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/src/c-api-wrapper-generation</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> engine/ApiWrapperGenerator</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> restore ApiWrapperGenerator.sln</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">dotnet</span> build <span class="at">--configuration</span> Debug <span class="at">--no-restore</span> ApiWrapperGenerator.sln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will create the library <code>c-api-wrapper-generation/engine/ApiWrapperGenerator/bin/Debug/netstandard2.0/ApiWrapperGenerator.dll</code>, which contains the glue code generation engine. More details about it later, but for now we will walk through the usage first.</p>
<p>One handy interactive option to “script” binding generation for a library is the <code>F#</code> language. A script to generate the python bindings for uchronia is as follow. Note that most of the <code>F#</code> scripting code below is also (re-)used for other C APIs than <code>uchronia</code>’s</p>
<p><em>Note: the following code is not yet publicly available. It should be in a revised post</em></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode fsharp code-with-copy"><code class="sourceCode fsharp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">open</span> System<span class="kw">.</span>Collections<span class="kw">.</span>Generic</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ot">#r "/home/abcdef/src/c-api-wrapper-generation/engine/ApiWrapperGenerator/bin/Debug/netstandard2.0/ApiWrapperGenerator.dll"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>//<span class="co"> #r @"C:\src\github_jm\c-api-wrapper-generation\engine\ApiWrapperGenerator\bin\Debug\netstandard2.0\ApiWrapperGenerator.dll"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ot">open</span> ApiWrapperGenerator</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ot">#load "gen_py_common.fsx"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ot">open</span> Gen_py_common</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="gen_py_common.fsx" class="level3">
<h3 class="anchored" data-anchor-id="gen_py_common.fsx">gen_py_common.fsx</h3>
<p>gen_py_common.fsx is a way to reuse boilerplate to generate code across several codebases. Typically, it includes a templated header with mostly similar functions with a few variations across use cases.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode fsharp code-with-copy"><code class="sourceCode fsharp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> prependHeaderTemplate = <span class="st">"##################</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="st"># </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st"># *** THIS FILE IS GENERATED ****</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st"># DO NOT MODIFY IT MANUALLY, AS YOU ARE VERY LIKELY TO LOSE WORK</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st"># </span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">##################</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st"># Some module imports such as:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">from datetime import datetime</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">from refcount.interop import CffiData, OwningCffiNativeHandle, DeletableCffiNativeHandle, wrap_as_pointer_handle</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">from cinterop.cffi.marshal import as_bytes, TimeSeriesGeometryNative</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st"># imports with string templating, for your specific package </span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="st">from {0}.wrap.ffi_interop import marshal, {1}, check_exceptions</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="st"># Additional specific imports for this package</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="st">{3}</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="st"># Some low-level conversion functions that will be called in the generated code:</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="st">def char_array_to_py(values:CffiData, dispose:bool=True) -&gt; str:</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="st">    pystring = marshal.c_string_as_py_string(values)</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="st">    if dispose:</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="st">        {1}.DeleteAnsiString(values)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="st">    return pystring</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="st">## etc. etc.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>{0}</code> will be replace with your python module name, <code>{1}</code> with the <code>cffi</code> wrapper interface to invoke the native library, e.g.&nbsp;<code>mylibrary_so</code>. This templated header is then used by a function <code>createPyWrapGen</code> that creates and configures the code generator:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode fsharp code-with-copy"><code class="sourceCode fsharp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> createPyWrapGen <span class="op">(</span>pkgName:<span class="dt">string</span>, cffiObjName:<span class="dt">string</span>, wrapperClassNames:<span class="dt">string</span>, otherImports:<span class="dt">string</span>, nativeDisposeFunction:<span class="dt">string</span>, typeMap:Dictionary&lt;<span class="dt">string</span>, <span class="dt">string</span>&gt;<span class="op">)</span> : PythonCffiWrapperGenerator = </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> pyCffiGen = PythonCffiWrapperGenerator<span class="op">()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The body of <code>createPyWrapGen</code> consists mostly of definitions mapping types across languages, C and Python in this case, so that the generator pyCffiGen knows how to convert from Python to C before calling a native C function, or how to convert or wrap a function returned from a C API call. There is provision for custom templates for “peculiar” functions.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode fsharp code-with-copy"><code class="sourceCode fsharp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    pyCffiGen.SetTypeMap<span class="op">(</span><span class="st">"char*"</span>, <span class="st">"str"</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    pyCffiGen.SetReturnedValueConversion<span class="op">(</span><span class="st">"char*"</span>, <span class="st">"char_array_to_py(C_ARGNAME, dispose=True)"</span><span class="op">)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    pyCffiGen.SetTransientArgConversion<span class="op">(</span> <span class="st">"char*"</span>  , <span class="st">"_charp"</span>, <span class="st">"C_ARGNAME = wrap_as_pointer_handle(as_bytes(RCPP_ARGNAME))"</span>, <span class="st">"# no cleanup for char*?"</span><span class="op">)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> returnscharptrptr = pyCffiGen.ReturnsCharPtrPtrWrapper<span class="op">()</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    pyCffiGen.AddCustomWrapper<span class="op">(</span>returnscharptrptr<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="back-to-the-main-script" class="level3">
<h3 class="anchored" data-anchor-id="back-to-the-main-script">Back to the main script</h3>
<p>We can then call this <code>pyCffiGen</code> function from the main script customised for the <code>uchronia</code> package:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode fsharp code-with-copy"><code class="sourceCode fsharp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> pkgName = <span class="st">"uchronia"</span> //<span class="co"> what goes into {0}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> cffiObjName = <span class="st">"uchronia_so"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>//<span class="co"> higher level package classes can be injected into the generated lower level binding, to make them more intelligible for user.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> wrapperClassNames=<span class="st">"    from uchronia.classes import (</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">        EnsembleTimeSeries,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">        TimeSeriesLibrary,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="st">        EnsembleForecastTimeSeries,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="st">        TimeSeries,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="st">        EnsemblePtrTimeSeries,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="st">        TimeSeriesProvider,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="st">    )</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> typeMap = Dictionary&lt;<span class="dt">string</span>, <span class="dt">string</span>&gt;<span class="op">()</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>typeMap.Add<span class="op">(</span><span class="st">"DATATYPES_ENSEMBLE_TIME_SERIES_DOUBLE_PTR"</span>, <span class="st">"'EnsembleTimeSeries'"</span><span class="op">)</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>typeMap.Add<span class="op">(</span><span class="st">"ENSEMBLE_DATA_SET_PTR"</span>, <span class="st">"'TimeSeriesLibrary'"</span><span class="op">)</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>typeMap.Add<span class="op">(</span><span class="st">"ENSEMBLE_FORECAST_TIME_SERIES_PTR"</span>, <span class="st">"'EnsembleForecastTimeSeries'"</span><span class="op">)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>typeMap.Add<span class="op">(</span><span class="st">"TIME_SERIES_PTR"</span>, <span class="st">"'TimeSeries'"</span><span class="op">)</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>//<span class="co"> etc. etc.</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> otherImports = <span class="st">""</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> nativeDisposeFunction = <span class="st">"DisposeSharedPointer_py"</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> pyCffiGen = createPyWrapGen <span class="op">(</span>pkgName, cffiObjName, wrapperClassNames, otherImports, nativeDisposeFunction, typeMap<span class="op">)</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>//<span class="co"> Specify a marker that identifiers a function as being part of the C API</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> exportModifierPattern = <span class="op">[|</span><span class="st">"DATATYPES_API"</span><span class="op">|]</span> </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>apiFilter.ContainsAny &lt;- exportModifierPattern</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>//<span class="co"> In this instance, this marker is not part of the C ANSI 99 function, so this is one of the strings to strip out of lines. </span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>apiFilter.ToRemove &lt;- exportModifierPattern </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> gen =  WrapperGenerator<span class="op">(</span>pyCffiGen, apiFilter<span class="op">)</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>//<span class="co"> Path to input C API file </span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> root = srcDir +/ <span class="st">"datatypes"</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> apiHeaderFile = root +/ <span class="st">"datatypes"</span> +/ <span class="st">"include"</span> +/ <span class="st">"datatypes"</span> +/ <span class="st">"extern_c_api.h"</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> outfile = root +/ <span class="st">"bindings"</span> +/ <span class="st">"python"</span> +/ <span class="st">"uchronia"</span> +/ <span class="st">"uchronia"</span> +/ <span class="st">"wrap"</span> +/ <span class="st">"uchronia_wrap_generated.py"</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>gen.CreateWrapperHeader<span class="op">(</span>apiHeaderFile, outfile<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This may seem like a lot of work to generate relatively little code, but trust me this is much preferable for one’s sanity compared to a “bovine”, manual glue code writing and maintenance over the long term.</p>
</section>
</section>
</section>
<section id="architecture" class="level1">
<h1>Architecture</h1>
<p>Below is a simplified class diagram of the code generation engine <code>ApiWrapperGenerator</code>. While fairly complicated this is a “low-brow” approach relying on string manipulation. There are probably smarter ways to do this, some perhaps not readily available back in 2014. But it works.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/c-api-gen/classes_only.svg"><img src="./images/c-api-gen/classes_only.svg" title="ApiWrapperGenerator architecture" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">ApiWrapperGenerator-architecture</figcaption><p></p>
</figure>
</div>
<!-- ![](../images/c-api-gen/classes_only.svg) -->
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This code generation tool has emerged from a specific context, after failing to apply SWIG to handle a C API with opaque pointers. There are brillant code gen tools other than SWIG out there, but all those I have come across are centered around generating in a single high-level language.</p>
<p>I have seen use cases in my organisation suggesting there is a potential for reusing these codegen tools. I wonder what communities and forums should be engaged to test this hypothesis and grow it.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© Copyright 2022 Jean-Michel Perraud. Except where otherwise noted, all text and images licensed CC-BY-NC 4.0.</div>   
  </div>
</footer>



</body></html>
---
title: "Toolkit for semi-distributed catchment delineation"
description: "Deriving semi-distributed catchment delineation from elevation data"
author:
  - name: J-M
    url: {}
date: "2024-07-13"
categories: ["spatial", "semi-distributed", "web app"]
format: 
  html:
    toc: true
engine: knitr
draft: false
---

# Background

I (we) will probably be working on a new streamflow forcasting system in Australia. In a conversation the project leader mentioned the upcoming song and dance to define a set of semi-distributed model structures (subareas, nodes, links) for several catchments.

Aside from the perhaps unavoidable arguments about which DEM and river network to use, it was noted that there was no known _readily_ available service within our organisation to quickly produce such catchment definitions, even if only for perliminary work. It sure is a feasible feature, and has been done many times in relative isolation by teams or individuals in more or less idiosyncratic manners. But so far as we know adapting these for our need would require, at best, a fair bit of adaptation.

Rather than yet implementing something within, and solely for, the project, can we implement something aiming to be more versatile, within and beyond the upcoming project?

# Use cases

* Set up a sensible daily semi-distributed streamflow model for the Goodradigbee river (NSW) upstream of Burrinjuck Dam, in ten minutes flat and from scratch
* Batch delineatin for at least 222 unregulated catchments of interest over Australia
* Delineate one catchment, and create a concrete model definition ([SWIFT](https://csiro-hydroinformatics.github.io/streamflow-forecasting-tools-onboard/)) that is ready to run populated with e.g. some [SILO](https://www.longpaddock.qld.gov.au/silo/) derived climate input data.

## Anticipated tools

Without unduly assuming solution implementation details, it is fair to expect:

* A web dashboard to visually define a catchment of interest.
  * load and/or click to define outlets and points of particular interest to split subcatchments.
  * Probably hosted at [shiny.csiro.au](https://shiny.csiro.au/) or its intranet twin.
* A python (_a priori_) package for programmatic access to features.

# Related work

Scouting for known or found work that may relate to the use cases. This is not exhaustive. 

## eWater Source

This product, functionally, may be the best suited to the needs elicited above, functionally: DEM derived river network, additional points to snap to the river for subcatchment definition, etc. It is implemented in .NET. This is not open source though. Although not a disqualifying aspect, it is not conducive to reusing with assurance our freedom to operate.

![Stung Staung River Source Model; picture from [https://ewater.org.au](https://ewater.org.au)](https://ewater.org.au/wp-content/uploads/2021/07/image-2.png)

## Basin futures

[Basin Futures](https://basinpedia.basinfutures.com/) includes a facility to define semi-distributed rainfall runoff models using [HydroSHEDS](https://www.hydrosheds.org/) data. 

The catchment delineation is done under the hood using [TauDEM](https://github.com/dtarb/TauDEM), which has python bindings but may require handling some temporary files (command line, C++ engine).

![Basinpedia Goodradigbee catchment](./basinpedia-goodra.png)

Aside from the immediate "subcatchment delineation" interest of ours, take the time to have a look at ["Basinpedia"](https://basinpedia.basinfutures.com/#/basinpedia) which is a great example using publicly availalable global data sets.

## AWRA Community Modelling System

I understand, second hand, that the [Australian Water Resources Assessment (AWRA) Community Modelling System](https://github.com/awracms/awra_cms) includes facilities to define catchments, or to perform weighted input time series averaging. I've previously tried to explore, but [could not recreate the conda environment](https://github.com/awracms/awra_cms/issues/2).

## Milos Makes Maps

[Milos Popovic](https://milospopovic.net) makes and shares gorgeous maps, using R. While I am not yet aware of sub-catchment delineation facilities off the shelf, check out the didactic youtube video [Visualize Like a Pro: 3D Elevation and River Maps Made Simple](https://t.co/mrywjX0CFI).

![Topography and rivers - France](./milos-maps-rivers-france.jpeg){width=50%}

## Global Watersheds

[Global watersheds](https://mghydro.com/watersheds/), Cool online tool, but does catchments not subcatchments. Powered by a [python codebase `delineator`](https://github.com/mheberger/delineator)

![Global watersheds](./global-watersheds.png)

## pysheds

[pysheds](https://mattbartos.com/pysheds/) python package. It is unclear whether it can do subcatchments.

## PCRaster

[Automatic delineation of subcatchments from a DEM using PCRaster Python](https://www.youtube.com/watch?v=vrS7x4jPeiw) and [Derive all subcatchments from a DEM using PCRaster in QGIS](https://www.youtube.com/watch?v=5uGaLIlaFh8)

## wflow

[wflow](https://github.com/openstreams/wflow/tree/master), which is now deprecated and now ported to Julia.

## hatariUti

Out of interest, a tool where you have to bring your own data. Demo mode available, but subscription to scale up.

[Video](https://www.youtube.com/watch?v=s8hhiJnyCqg&feature=emb_imp_woyt)

# Time series observations

The catchment/subcatchment delineation is purely a spatial exercise. It has some outputs that should stand on their own (vector and raster data).

A complementary service is to derive from these spatial data a model structure (e.g. rainfall-runoff models, and river reaches with streamflow routing), and the final step is to attribute input time series to these runoff/streamflow models. Some of the third party work listed above (Basin Futures and eWater Source) have this capability.


It is a pet peeve of mine (and colleagues) that foundational time series data in hydrology remains deceptively difficult to ingest and exploit (in Australia at least). There is a **lot** of residual impedance (technological and organisational) between point of truth data and a hydrologist's notebook. I am _sure_ I have gaps of know how, part of the problem, but FWIW I am not the only one feeling this way.

Below is a short list of observations/input data resources that may be relevant to our catchment model builder services.

::: {.callout-note}

_CSIRO may have some internal time series data resources under licences; I will not mention nor list these in this post._

:::

## Climate inputs

Notwithstanding the additional resources "we" may have access to under license, the following resources (prob. not exhaustive) are publicly available.

* [SILO](https://www.longpaddock.qld.gov.au/silo/), gridded product or points stations.
* [AGDC](http://www.bom.gov.au/metadata/catalogue/19115/ANZCW0503900567)
  * Note the disappointing "DownloadableData : Openly accessible thredds INDEX webpage for data (opendap, etc) (not yet available)"
* [the Bureau of Meteorology Climate Data Online](http://www.bom.gov.au/climate/data/). Note that behind the scene there may be a temporal resolution down to 30 or even 10 minutes observations (rain gauges), but these are not readily available publicly.

## Instream observations

While not a typical time series input to many models, they are key to being able to calibrate models.

* Streamflow observations
  * daily
    * [Water Data Online](http://www.bom.gov.au/waterdata/). A python package [pybomwater](https://github.com/csiro-hydroinformatics/pybomwater) is designed for programmatic access. Note that the Bureau service it taps into is throttled, as I write, so beware not to fetch large quantities of observation sites.
    * global datasets
      * [GRDC](https://grdc.bafg.de/GRDC/EN/Home/homepage_node.html).
      * CAMELS-x datasets. Also include preorocessed climate time series usable as inputs.
  * sub-daily
    * [Water Data Online](http://www.bom.gov.au/waterdata/) also has down to 10 minutes observations, at least for some gauges. See figures below.
    * State agencies. For instance I previously made a [post about the Victorian Water Measurement Information System](https://jmp75.github.io/work-blog/posts/2022-05-28-hydstra-rest-data.html). Water Data Online is in principle supposed to be a superset, but some data points may not be ingested. 

### Water Data Online

Besides the python package [pybomwater](https://github.com/csiro-hydroinformatics/pybomwater), the manual visualisation/download facilities of Water Data Online:

![Streamflow Goodradigbee at Wee Jasper](streamflow-gauge-410024.png)

![1 year data Goodradigbee at Wee Jasper (10 min resolution, at least for this gauge)](streamflow-data-gauge-410024.png)


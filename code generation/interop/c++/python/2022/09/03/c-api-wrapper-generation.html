<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Generate programming language bindings to a C API | J-M’s “lab notebook”</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Generate programming language bindings to a C API" />
<meta name="author" content="<a href='https://github.com/jmp75'>J-M</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Generate language binging for Python, R and other wrappers on top of a C API" />
<meta property="og:description" content="Generate language binging for Python, R and other wrappers on top of a C API" />
<link rel="canonical" href="https://jmp75.github.io/work-blog/code%20generation/interop/c++/python/2022/09/03/c-api-wrapper-generation.html" />
<meta property="og:url" content="https://jmp75.github.io/work-blog/code%20generation/interop/c++/python/2022/09/03/c-api-wrapper-generation.html" />
<meta property="og:site_name" content="J-M’s “lab notebook”" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-03T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Generate programming language bindings to a C API" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='https://github.com/jmp75'>J-M</a>"},"dateModified":"2022-09-03T00:00:00-05:00","datePublished":"2022-09-03T00:00:00-05:00","description":"Generate language binging for Python, R and other wrappers on top of a C API","headline":"Generate programming language bindings to a C API","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmp75.github.io/work-blog/code%20generation/interop/c++/python/2022/09/03/c-api-wrapper-generation.html"},"url":"https://jmp75.github.io/work-blog/code%20generation/interop/c++/python/2022/09/03/c-api-wrapper-generation.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/work-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmp75.github.io/work-blog/feed.xml" title="J-M's &quot;lab notebook&quot;" /><link rel="shortcut icon" type="image/x-icon" href="/work-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/work-blog/">J-M&#39;s &quot;lab notebook&quot;</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/work-blog/about/">About Me</a><a class="page-link" href="/work-blog/search/">Search</a><a class="page-link" href="/work-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Generate programming language bindings to a C API</h1><p class="page-description">Generate language binging for Python, R and other wrappers on top of a C API</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-03T00:00:00-05:00" itemprop="datePublished">
        Sep 3, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://github.com/jmp75'>J-M</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/work-blog/categories/#code generation">code generation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#interop">interop</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#C++">C++</a>
        &nbsp;
      
        <a class="category-tags-link" href="/work-blog/categories/#Python">Python</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a>
<ul>
<li class="toc-entry toc-h2"><a href="#history">History</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#glue-code-generation---context-and-review">Glue code generation - context and review</a>
<ul>
<li class="toc-entry toc-h2"><a href="#foreword---google-search">Foreword - Google search</a></li>
<li class="toc-entry toc-h2"><a href="#brief-scan-of-the-state-of-the-art">Brief scan of the state of the art</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#sample-usage">Sample usage</a>
<ul>
<li class="toc-entry toc-h2"><a href="#c-api">C API</a></li>
<li class="toc-entry toc-h2"><a href="#outline-generating-the-python-glue-code">Outline generating the python glue code</a>
<ul>
<li class="toc-entry toc-h3"><a href="#gen_py_commonfsx">gen_py_common.fsx</a></li>
<li class="toc-entry toc-h3"><a href="#back-to-the-main-script">Back to the main script</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#architecture">Architecture</a></li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
</ul><p><img src="/work-blog/images/c-api-gen/codegen-wrappers.svg" alt="gluecode-generation" title="Glue code generation"></p>

<h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>The codebase <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/">Uchronia - time series handling for ensembles simulations and forecasts in C++</a> comprises a C++ core, and a C Application Programming Interface with Python, R, Matlab (and other) bindings. This is part of a <a href="https://github.com/csiro-hydroinformatics/streamflow-forecasting-tools-onboard">software stack for streamflow forecasting</a>. Some elements of the software stack similar to Uchronia have large C APIs. Even with a very stable C API (and they often were not at some point), it is mind-numbing, inefficient and bug-prone to generate <a href="https://en.wikipedia.org/wiki/Language_binding">language bindings (glue code)</a> manually.</p>

<p>What I am writing about in this post is utility code for <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">interoperability code generation</a> that grew out of scientific software, and perhaps should have advertised in its own right.</p>

<h2 id="history">
<a class="anchor" href="#history" aria-hidden="true"><span class="octicon octicon-link"></span></a>History</h2>

<p>In 2014 after settling for C++ for a modelling core. I had R, Matlab and Python users, some need to interop with C# code. And some constraints on using different C++ compilers in the stack. So I decided on designing C APIs, the <em>lingua franca</em> of in-process interop. I had some prior exposure to the Mono C core and interop with R. But not extensive first hand.</p>

<p>My first port of call for glue code was a no-brainer: <a href="https://www.swig.org/">SWIG</a>, which I first encountered in an internship in… 1997. I did not document my tribulations in details, but I encountered many difficulties when testing feasibility. Basically, I concluded that SWIG was just not a good fit for a C API like mine, especially one with opaque pointers (<code class="language-plaintext highlighter-rouge">void*</code>).</p>

<p>There were other offering for code generation for R, or Python. But apart from SWIG, I do not recall locating any suitable glue code generation for multiple target languages. I may revisit in more details the tribulations in another post, but this was the reason for the inception of <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a>.</p>

<h1 id="glue-code-generation---context-and-review">
<a class="anchor" href="#glue-code-generation---context-and-review" aria-hidden="true"><span class="octicon octicon-link"></span></a>Glue code generation - context and review</h1>

<h2 id="foreword---google-search">
<a class="anchor" href="#foreword---google-search" aria-hidden="true"><span class="octicon octicon-link"></span></a>Foreword - Google search</h2>

<p>Before starting this post, I wanted to check out what was the state of play out there and I was googling using the terms “generate bindings for a C API”. Our <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a> was coming up in the first few items. I thought Google was biasing the search given the wealth of information it has, I mean, come on, there must be thousands of similar endeavours out there. No way.</p>

<p>But, after some friends help and simulating searches from another geolocation, it seems Google is not cheating.</p>

<p>Not sure what to make of this yet. Oh, and searching “generating binding to a c api” instead of “generating bindings to a c api” wields a different list…</p>

<p>Anyway, a quick review before looking at <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">c-api-wrapper-generation</a>.</p>

<h2 id="brief-scan-of-the-state-of-the-art">
<a class="anchor" href="#brief-scan-of-the-state-of-the-art" aria-hidden="true"><span class="octicon octicon-link"></span></a>Brief scan of the state of the art</h2>

<p>There is an excellent post <a href="https://floooh.github.io/2020/08/23/sokol-bindgen.html">Automatic Language Bindings</a> by <a href="https://github.com/floooh">Andrew Weissflog</a>, which I recommend. Many statements and observations resonate with me. Related directly or indirectly to the post above (I intuit) I found <a href="https://github.com/bottlenoselabs/c2cs">C2CS</a>. I am very intrigued by their use of an abstract syntax tree (AST), I think. My approach was more crude (but perhaps pragmatic).</p>

<p>From the Rust community <a href="https://users.rust-lang.org/t/creating-bindings-to-c-apis/23819">this thread</a> and <a href="https://github.com/rust-lang/rust-bindgen">rust-bindgen</a></p>

<p>A wealth of resources in <a href="http://lua-users.org/wiki/BindingCodeToLua">BindingCodeToLua</a></p>

<p><a href="https://github.com/pybind/pybind11">pybind11</a> is something I already looked at 3 years ago in <a href="https://medium.com/@jean.michel.perraud/using-pybind11-for-cross-module-c-api-bindings-5e50925d5684">this post</a>. I probably would have settled on it if it was purely about Python bindings, directly to the C++ code.</p>

<h1 id="sample-usage">
<a class="anchor" href="#sample-usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample usage</h1>

<p>Let’s start with a sample usage. This is based on code that has evolved over time rather than something purely didactic, but should give an idea of the process. I may update this post if I reshape things to be more didactic.</p>

<h2 id="c-api">
<a class="anchor" href="#c-api" aria-hidden="true"><span class="octicon octicon-link"></span></a>C API</h2>

<p>The codebase uchronia has a <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/datatypes/include/datatypes/extern_c_api.h">C API with functions</a> such as:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">DATATYPES_API</span> <span class="kt">char</span><span class="o">**</span> <span class="nf">GetEnsembleDatasetDataIdentifiers</span><span class="p">(</span><span class="n">ENSEMBLE_DATA_SET_PTR</span> <span class="n">dataLibrary</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">DATATYPES_API</span> <span class="n">ENSEMBLE_FORECAST_TIME_SERIES_PTR</span> <span class="nf">CreateEnsembleForecastTimeSeries</span><span class="p">(</span><span class="n">date_time_to_second</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">timeStepName</span><span class="p">);</span>
	<span class="n">DATATYPES_API</span> <span class="kt">void</span> <span class="nf">GetTimeSeriesValues</span><span class="p">(</span><span class="n">TIME_SERIES_PTR</span> <span class="n">timeSeries</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span> <span class="n">values</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arrayLength</span><span class="p">);</span>
</code></pre></div></div>

<p>The <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/python/uchronia/uchronia/wrap/uchronia_wrap_generated.py">low-level Python binding generated</a> from parsing this C API result in the following type of code. Note that opaque pointers such as <code class="language-plaintext highlighter-rouge">ENSEMBLE_DATA_SET_PTR</code> have corresponding higher level Python class equivalents such as <code class="language-plaintext highlighter-rouge">TimeSeriesLibrary</code>, even in the “low-level” glue code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">GetEnsembleDatasetDataIdentifiers_py</span><span class="p">(</span><span class="n">dataLibrary</span><span class="p">:</span><span class="s">'TimeSeriesLibrary'</span><span class="p">):</span>
    <span class="n">dataLibrary_xptr</span> <span class="o">=</span> <span class="n">wrap_as_pointer_handle</span><span class="p">(</span><span class="n">dataLibrary</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">marshal</span><span class="p">.</span><span class="n">new_int_scalar_ptr</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">uchronia_so</span><span class="p">.</span><span class="n">GetEnsembleDatasetDataIdentifiers</span><span class="p">(</span><span class="n">dataLibrary_xptr</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">charp_array_to_py</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">CreateEnsembleForecastTimeSeries_py</span><span class="p">(</span><span class="n">start</span><span class="p">:</span><span class="n">datetime</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">timeStepName</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'EnsembleForecastTimeSeries'</span><span class="p">:</span>
    <span class="c1"># glue code
</span><span class="k">def</span> <span class="nf">GetTimeSeriesValues_py</span><span class="p">(</span><span class="n">timeSeries</span><span class="p">:</span><span class="s">'TimeSeries'</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">arrayLength</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># glue code
</span></code></pre></div></div>

<p>For information, the equivalent generated glue code for an R package <code class="language-plaintext highlighter-rouge">uchronia</code> are in files <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/R/pkgs/uchronia/src/rcpp_generated.cpp">src/rcpp_generated.cpp</a> and <a href="https://github.com/csiro-hydroinformatics/uchronia-time-series/blob/research/bindings/R/pkgs/uchronia/R/uchronia-pkg-wrap-generated.r">R/uchronia-pkg-wrap-generated.r</a>.</p>

<h2 id="outline-generating-the-python-glue-code">
<a class="anchor" href="#outline-generating-the-python-glue-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Outline generating the python glue code</h2>

<p>See the <a href="https://github.com/csiro-hydroinformatics/c-api-wrapper-generation">wrapper generator c-api-wrapper-generation</a>. The README.md has setup instructions for dotnet, if need be.</p>

<p>There is a history behind why the conversion engine runs on .NET (and is written in C#), but I will not dwell on it in this post. Note that as of August 2022, even on Linux packages from the .NET ecosystem are readily available from Microsoft or even Ubuntu official package repositories.</p>

<p>If you have dotnet installed <code class="language-plaintext highlighter-rouge">dotnet --info</code> returns as of August 2022:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.NET SDK (reflecting any global.json):
 Version:   6.0.302
 Commit:    c857713418

Runtime Environment:
 OS Name:     debian
 OS Version:  11
 OS Platform: Linux
 RID:         debian.11-x64
 Base Path:   /usr/share/dotnet/sdk/6.0.302/

global.json file:
  Not found

Host:
  Version:      6.0.7
  Architecture: x64
  Commit:       0ec02c8c96

.NET SDKs installed:
  6.0.302 [/usr/share/dotnet/sdk]

.NET runtimes installed:
  Microsoft.AspNetCore.App 6.0.7 [/usr/share/dotnet/shared/Microsoft.AspNetCore.App]
  Microsoft.NETCore.App 3.1.27 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
  Microsoft.NETCore.App 6.0.7 [/usr/share/dotnet/shared/Microsoft.NETCore.App]
</code></pre></div></div>

<p>The codegen engine is C#, and we’ll give an overview later. Compiling it is done like so:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/src/c-api-wrapper-generation
<span class="nb">cd </span>engine/ApiWrapperGenerator
dotnet restore ApiWrapperGenerator.sln
dotnet build <span class="nt">--configuration</span> Debug <span class="nt">--no-restore</span> ApiWrapperGenerator.sln
</code></pre></div></div>

<p>This will create the library <code class="language-plaintext highlighter-rouge">c-api-wrapper-generation/engine/ApiWrapperGenerator/bin/Debug/netstandard2.0/ApiWrapperGenerator.dll</code>, which contains the glue code generation engine. More details about it later, but for now we will walk through the usage first.</p>

<p>One handy interactive option to “script” binding generation for a library is the <code class="language-plaintext highlighter-rouge">F#</code> language. A script to generate the python bindings for uchronia is as follow. Note that most of the <code class="language-plaintext highlighter-rouge">F#</code> scripting code below is also (re-)used for other C APIs than <code class="language-plaintext highlighter-rouge">uchronia</code>’s</p>

<p><em>Note: the following code is not yet publicly available. It should be in a revised post</em></p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>

<span class="p">#</span><span class="n">r</span> <span class="s2">"/home/per202/src/c-api-wrapper-generation/engine/ApiWrapperGenerator/bin/Debug/netstandard2.0/ApiWrapperGenerator.dll"</span>
<span class="c1">// #r @"C:\src\github_jm\c-api-wrapper-generation\engine\ApiWrapperGenerator\bin\Debug\netstandard2.0\ApiWrapperGenerator.dll"</span>
<span class="k">open</span> <span class="nc">ApiWrapperGenerator</span>

<span class="p">#</span><span class="n">load</span> <span class="s2">"gen_py_common.fsx"</span>
<span class="k">open</span> <span class="nc">Gen_py_common</span>
</code></pre></div></div>

<h3 id="gen_py_commonfsx">
<a class="anchor" href="#gen_py_commonfsx" aria-hidden="true"><span class="octicon octicon-link"></span></a>gen_py_common.fsx</h3>

<p>gen_py_common.fsx is a way to reuse boilerplate to generate code across several codebases. Typically, it includes a templated header with mostly similar functions with a few variations across use cases.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">prependHeaderTemplate</span> <span class="p">=</span> <span class="s2">"##################
# 
# *** THIS FILE IS GENERATED ****
# DO NOT MODIFY IT MANUALLY, AS YOU ARE VERY LIKELY TO LOSE WORK
# 
##################

# Some module imports such as:
from datetime import datetime
from refcount.interop import CffiData, OwningCffiNativeHandle, DeletableCffiNativeHandle, wrap_as_pointer_handle
from cinterop.cffi.marshal import as_bytes, TimeSeriesGeometryNative
# imports with string templating, for your specific package 
from {0}.wrap.ffi_interop import marshal, {1}, check_exceptions
# Additional specific imports for this package
{3}

# Some low-level conversion functions that will be called in the generated code:
def char_array_to_py(values:CffiData, dispose:bool=True) -&gt; str:
    pystring = marshal.c_string_as_py_string(values)
    if dispose:
        {1}.DeleteAnsiString(values)
    return pystring

## etc. etc.

"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">{0}</code> will be replace with your python module name, <code class="language-plaintext highlighter-rouge">{1}</code> with the <code class="language-plaintext highlighter-rouge">cffi</code> wrapper interface to invoke the native library, e.g. <code class="language-plaintext highlighter-rouge">mylibrary_so</code>. This templated header is then used by a function <code class="language-plaintext highlighter-rouge">createPyWrapGen</code> that creates and configures the code generator:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">createPyWrapGen</span> <span class="p">(</span><span class="n">pkgName</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">cffiObjName</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">wrapperClassNames</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">otherImports</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">nativeDisposeFunction</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">typeMap</span><span class="p">:</span><span class="nc">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;)</span> <span class="p">:</span> <span class="nc">PythonCffiWrapperGenerator</span> <span class="p">=</span> 
    <span class="k">let</span> <span class="n">pyCffiGen</span> <span class="p">=</span> <span class="nc">PythonCffiWrapperGenerator</span><span class="bp">()</span>
</code></pre></div></div>

<p>The body of <code class="language-plaintext highlighter-rouge">createPyWrapGen</code> consists mostly of definitions mapping types across languages, C and Python in this case, so that the generator pyCffiGen knows how to convert from Python to C before calling a native C function, or how to convert or wrap a function returned from a C API call. There is provision for custom templates for “peculiar” functions.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">pyCffiGen</span><span class="p">.</span><span class="nc">SetTypeMap</span><span class="p">(</span><span class="s2">"char*"</span><span class="p">,</span> <span class="s2">"str"</span><span class="p">)</span>
    <span class="n">pyCffiGen</span><span class="p">.</span><span class="nc">SetReturnedValueConversion</span><span class="p">(</span><span class="s2">"char*"</span><span class="p">,</span> <span class="s2">"char_array_to_py(C_ARGNAME, dispose=True)"</span><span class="p">)</span>
    <span class="n">pyCffiGen</span><span class="p">.</span><span class="nc">SetTransientArgConversion</span><span class="p">(</span> <span class="s2">"char*"</span>  <span class="p">,</span> <span class="s2">"_charp"</span><span class="p">,</span> <span class="s2">"C_ARGNAME = wrap_as_pointer_handle(as_bytes(RCPP_ARGNAME))"</span><span class="p">,</span> <span class="s2">"# no cleanup for char*?"</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">returnscharptrptr</span> <span class="p">=</span> <span class="n">pyCffiGen</span><span class="p">.</span><span class="nc">ReturnsCharPtrPtrWrapper</span><span class="bp">()</span>
    <span class="n">pyCffiGen</span><span class="p">.</span><span class="nc">AddCustomWrapper</span><span class="p">(</span><span class="n">returnscharptrptr</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="back-to-the-main-script">
<a class="anchor" href="#back-to-the-main-script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Back to the main script</h3>

<p>We can then call this <code class="language-plaintext highlighter-rouge">pyCffiGen</code> function from the main script customised for the <code class="language-plaintext highlighter-rouge">uchronia</code> package:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">pkgName</span> <span class="p">=</span> <span class="s2">"uchronia"</span> <span class="c1">// what goes into {0}</span>
<span class="k">let</span> <span class="n">cffiObjName</span> <span class="p">=</span> <span class="s2">"uchronia_so"</span>

<span class="c1">// higher level package classes can be injected into the generated lower level binding, to make them more intelligible for user.</span>
<span class="k">let</span> <span class="n">wrapperClassNames</span><span class="p">=</span><span class="s2">"    from uchronia.classes import (
        EnsembleTimeSeries,
        TimeSeriesLibrary,
        EnsembleForecastTimeSeries,
        TimeSeries,
        EnsemblePtrTimeSeries,
        TimeSeriesProvider,
    )
"</span>

<span class="k">let</span> <span class="n">typeMap</span> <span class="p">=</span> <span class="nc">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;()</span>
<span class="n">typeMap</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"DATATYPES_ENSEMBLE_TIME_SERIES_DOUBLE_PTR"</span><span class="p">,</span> <span class="s2">"'EnsembleTimeSeries'"</span><span class="p">)</span>
<span class="n">typeMap</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"ENSEMBLE_DATA_SET_PTR"</span><span class="p">,</span> <span class="s2">"'TimeSeriesLibrary'"</span><span class="p">)</span>
<span class="n">typeMap</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"ENSEMBLE_FORECAST_TIME_SERIES_PTR"</span><span class="p">,</span> <span class="s2">"'EnsembleForecastTimeSeries'"</span><span class="p">)</span>
<span class="n">typeMap</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"TIME_SERIES_PTR"</span><span class="p">,</span> <span class="s2">"'TimeSeries'"</span><span class="p">)</span>
<span class="c1">// etc. etc.</span>

<span class="k">let</span> <span class="n">otherImports</span> <span class="p">=</span> <span class="s2">""</span>
<span class="k">let</span> <span class="n">nativeDisposeFunction</span> <span class="p">=</span> <span class="s2">"DisposeSharedPointer_py"</span>

<span class="k">let</span> <span class="n">pyCffiGen</span> <span class="p">=</span> <span class="n">createPyWrapGen</span> <span class="p">(</span><span class="n">pkgName</span><span class="p">,</span> <span class="n">cffiObjName</span><span class="p">,</span> <span class="n">wrapperClassNames</span><span class="p">,</span> <span class="n">otherImports</span><span class="p">,</span> <span class="n">nativeDisposeFunction</span><span class="p">,</span> <span class="n">typeMap</span><span class="p">)</span>

<span class="c1">// Specify a marker that identifiers a function as being part of the C API</span>
<span class="k">let</span> <span class="n">exportModifierPattern</span> <span class="p">=</span> <span class="p">[|</span><span class="s2">"DATATYPES_API"</span><span class="p">|]</span> 
<span class="n">apiFilter</span><span class="p">.</span><span class="nc">ContainsAny</span> <span class="p">&lt;-</span> <span class="n">exportModifierPattern</span>
<span class="c1">// In this instance, this marker is not part of the C ANSI 99 function, so this is one of the strings to strip out of lines. </span>
<span class="n">apiFilter</span><span class="p">.</span><span class="nc">ToRemove</span> <span class="p">&lt;-</span> <span class="n">exportModifierPattern</span> 

<span class="k">let</span> <span class="n">gen</span> <span class="p">=</span>  <span class="nc">WrapperGenerator</span><span class="p">(</span><span class="n">pyCffiGen</span><span class="p">,</span> <span class="n">apiFilter</span><span class="p">)</span>

<span class="c1">// Path to input C API file </span>
<span class="k">let</span> <span class="n">root</span> <span class="p">=</span> <span class="n">srcDir</span> <span class="o">+/</span> <span class="s2">"datatypes"</span>
<span class="k">let</span> <span class="n">apiHeaderFile</span> <span class="p">=</span> <span class="n">root</span> <span class="o">+/</span> <span class="s2">"datatypes"</span> <span class="o">+/</span> <span class="s2">"include"</span> <span class="o">+/</span> <span class="s2">"datatypes"</span> <span class="o">+/</span> <span class="s2">"extern_c_api.h"</span>
<span class="k">let</span> <span class="n">outfile</span> <span class="p">=</span> <span class="n">root</span> <span class="o">+/</span> <span class="s2">"bindings"</span> <span class="o">+/</span> <span class="s2">"python"</span> <span class="o">+/</span> <span class="s2">"uchronia"</span> <span class="o">+/</span> <span class="s2">"uchronia"</span> <span class="o">+/</span> <span class="s2">"wrap"</span> <span class="o">+/</span> <span class="s2">"uchronia_wrap_generated.py"</span>

<span class="n">gen</span><span class="p">.</span><span class="nc">CreateWrapperHeader</span><span class="p">(</span><span class="n">apiHeaderFile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</code></pre></div></div>

<p>This may seem like a lot of work to generate relatively little code, but trust me this is much preferable for one’s sanity compared to a “bovine”, manual glue code writing and maintenance over the long term.</p>

<h1 id="architecture">
<a class="anchor" href="#architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>Architecture</h1>

<p>Below is a simplified class diagram of the code generation engine <code class="language-plaintext highlighter-rouge">ApiWrapperGenerator</code>. While fairly complicated this is a “low-brow” approach relying on string manipulation. There are probably smarter ways to do this, some perhaps not readily available back in 2014. But it works.</p>

<p><a href="/work-blog/images/c-api-gen/classes_only.svg"><img src="/work-blog/images/c-api-gen/classes_only.svg" alt="ApiWrapperGenerator-architecture" title="ApiWrapperGenerator architecture"></a></p>

<!-- ![](../images/c-api-gen/classes_only.svg) -->

<h1 id="conclusion">
<a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1>

<p>This code generation tool has emerged from a specific context, after failing to apply SWIG to handle a C API with opaque pointers. There are brillant code gen tools other than SWIG out there, but all those I have come across are centered around generating in a single high-level language.</p>

<p>I have seen use cases in my organisation suggesting there is a potential for reusing these codegen tools. I wonder what communities and forums should be engaged to test this hypothesis and grow it.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jmp75/work-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/work-blog/code%20generation/interop/c++/python/2022/09/03/c-api-wrapper-generation.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/work-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/work-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/work-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Work-related posts for the so-called grey literature.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmp75" target="_blank" title="jmp75"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jmp_oz" target="_blank" title="jmp_oz"><svg class="svg-icon grey"><use xlink:href="/work-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
